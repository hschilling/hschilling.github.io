
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Simultaneous Coloring of Approximated Derivatives &#8212; OpenMDAO 2.8.0 Beta documentation</title>
    <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/OpenMDAO_Favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Examples" href="../../examples/index.html" />
    <link rel="prev" title="XDSM generation" href="xdsm_visualization.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../examples/index.html" title="Examples"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="xdsm_visualization.html" title="XDSM generation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenMDAO 2.8.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Features</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Experimental Features</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/OpenMDAO_Logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_guide/index.html">Basic User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_guide/index.html">Advanced User Guide</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory_manual/index.html">Theory Manual</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../other/om_command.html">Command Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/citing.html">How to Cite OpenMDAO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/repo_guide/index.html">Building a Tool on Top of OpenMDAO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/api_translation.html">Upgrading from OpenMDAO 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/file_wrap.html">File Wrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_srcdocs/index.html">Source Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_docs/index.html">Developer Docs (if you’re going to contribute code)</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Search OpenMDAO</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="checkbox" name="search_source" /> Include Source Docs
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="simultaneous-coloring-of-approximated-derivatives">
<span id="feature-simul-coloring-approx"></span><h1>Simultaneous Coloring of Approximated Derivatives<a class="headerlink" href="#simultaneous-coloring-of-approximated-derivatives" title="Permalink to this headline">¶</a></h1>
<p>In OpenMDAO, partial derivatives for components and semi-total derivatives for groups can
be approximated using either finite difference or complex step.  Sometimes the partial or
semi-total jacobians in these cases are sparse, and the computing of these jacobians can
be made more efficient using simultaneous derivative coloring.  For an explanation of a
similar coloring for <em>total</em> derivatives, see
<a class="reference internal" href="../core_features/working_with_derivatives/simul_derivs.html#feature-simul-coloring"><span class="std std-ref">Simultaneous Coloring For Separable Problems</span></a>.  Finite difference
and complex step only work in forward mode, so only a forward mode coloring is possible when
using them, but depending on the sparsity pattern of the jacobian, it may still be possible
to get significant efficiency gains.</p>
<div class="section" id="dynamic-coloring">
<h2>Dynamic Coloring<a class="headerlink" href="#dynamic-coloring" title="Permalink to this headline">¶</a></h2>
<p>Setting up a problem to use dynamic coloring of approximated derivatives requires a
call to the <code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code> function.</p>
<dl class="method">
<dt>
<code class="descclassname">System.</code><code class="descname">declare_coloring</code><span class="sig-paren">(</span><em>wrt=('*'</em>, <em>)</em>, <em>method='fd'</em>, <em>form=None</em>, <em>step=None</em>, <em>per_instance=False</em>, <em>num_full_jacs=3</em>, <em>tol=1e-25</em>, <em>orders=None</em>, <em>perturb_size=1e-09</em>, <em>show_summary=True</em>, <em>show_sparsity=False</em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/openmdao/core/system.html#System.declare_coloring"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Set options for deriv coloring of a set of wrt vars matching the given pattern(s).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><dl class="first last docutils">
<dt><strong>wrt</strong> <span class="classifier-delimiter">:</span> <span class="classifier">str or list of str</span></dt>
<dd><p class="first last">The name or names of the variables that derivatives are taken with respect to.
This can contain input names, output names, or glob patterns.</p>
</dd>
<dt><strong>method</strong> <span class="classifier-delimiter">:</span> <span class="classifier">str</span></dt>
<dd><p class="first last">Method used to compute derivative: “fd” for finite difference, “cs” for complex step.</p>
</dd>
<dt><strong>form</strong> <span class="classifier-delimiter">:</span> <span class="classifier">str</span></dt>
<dd><p class="first last">Finite difference form, can be “forward”, “central”, or “backward”. Leave
undeclared to keep unchanged from previous or default value.</p>
</dd>
<dt><strong>step</strong> <span class="classifier-delimiter">:</span> <span class="classifier">float</span></dt>
<dd><p class="first last">Step size for finite difference. Leave undeclared to keep unchanged from previous
or default value.</p>
</dd>
<dt><strong>per_instance</strong> <span class="classifier-delimiter">:</span> <span class="classifier">bool</span></dt>
<dd><p class="first last">If True, a separate coloring will be generated for each instance of a given class.
Otherwise, only one coloring for a given class will be generated and all instances
of that class will use it.</p>
</dd>
<dt><strong>num_full_jacs</strong> <span class="classifier-delimiter">:</span> <span class="classifier">int</span></dt>
<dd><p class="first last">Number of times to repeat partial jacobian computation when computing sparsity.</p>
</dd>
<dt><strong>tol</strong> <span class="classifier-delimiter">:</span> <span class="classifier">float</span></dt>
<dd><p class="first last">Tolerance used to determine if an array entry is nonzero during sparsity determination.</p>
</dd>
<dt><strong>orders</strong> <span class="classifier-delimiter">:</span> <span class="classifier">int</span></dt>
<dd><p class="first last">Number of orders above and below the tolerance to check during the tolerance sweep.</p>
</dd>
<dt><strong>perturb_size</strong> <span class="classifier-delimiter">:</span> <span class="classifier">float</span></dt>
<dd><p class="first last">Size of input/output perturbation during generation of sparsity.</p>
</dd>
<dt><strong>show_summary</strong> <span class="classifier-delimiter">:</span> <span class="classifier">bool</span></dt>
<dd><p class="first last">If True, display summary information after generating coloring.</p>
</dd>
<dt><strong>show_sparsity</strong> <span class="classifier-delimiter">:</span> <span class="classifier">bool</span></dt>
<dd><p class="first last">If True, display sparsity with coloring info after generating coloring.</p>
</dd>
</dl>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>For example, the code below sets up coloring for
partial derivatives of outputs of <cite>comp</cite> with respect to inputs of <cite>comp</cite> starting with ‘x’.
Let’s assume here that <code class="code docutils literal notranslate"><span class="pre">MyComp</span></code> is an <code class="code docutils literal notranslate"><span class="pre">ExplicitComponent</span></code>.  If it were an
<code class="code docutils literal notranslate"><span class="pre">ImplicitComponent</span></code>, then the wildcard pattern ‘x*’ would be applied to all inputs <em>and</em>
outputs (states) of <cite>comp</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">comp</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="n">MyComp</span><span class="p">())</span>
<span class="n">comp</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="s1">&#39;x*&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cs&#39;</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that in the call to <code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code>, we also set <code class="code docutils literal notranslate"><span class="pre">num_full_jacs</span></code> to 2.  This means
that the first 2 times that a partial jacobian is computed for ‘comp’, it’s values will be computed
without coloring and stored.  Just prior to the 3rd time, the coloring will be computed and used for
the rest of the run.</p>
<p>Semi-total derivative coloring can be performed in a similar way, except that
<code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code> would be called on a <code class="code docutils literal notranslate"><span class="pre">Group</span></code> instead of a <code class="code docutils literal notranslate"><span class="pre">Component</span></code>.
<code class="code docutils literal notranslate"><span class="pre">num_full_jacs</span></code> can also be passed as an arg to <code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code> on the <code class="code docutils literal notranslate"><span class="pre">Group</span></code>.</p>
<p>The purpose of <code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code> is to provide all of the necessary information to allow
OpenMDAO to generate a coloring, either dynamically or manually using <code class="code docutils literal notranslate"><span class="pre">openmdao</span> <span class="pre">partial_coloring</span></code>.</p>
<p>Coloring files that are generated dynamically will be placed in the directory specified in
<code class="code docutils literal notranslate"><span class="pre">problem.options['coloring_dir']</span></code> and will be named based on the value of the
<code class="code docutils literal notranslate"><span class="pre">per_instance</span></code> arg passed to <code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code>.  If <code class="code docutils literal notranslate"><span class="pre">per_instance</span></code> is True,
the file will be named based on the full pathname of the component or group being colored.  If
False, the name will be based on the full module pathname of the class of the given
component or group.</p>
<p><code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code> should generally be called in the <code class="code docutils literal notranslate"><span class="pre">setup</span></code> function of the
component or group.</p>
<p>Here’s a modified version of our total coloring example, where we replace one of our components
with one that computes a dynamic partial coloring.  A total coloring is also performed, as in the
previous example, but this time the total coloring uses sparsity information computed by our
component during its dynamic partial coloring.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openmdao.api</span> <span class="kn">as</span> <span class="nn">om</span>

<span class="k">class</span> <span class="nc">DynamicPartialsComp</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">ExplicitComponent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DynamicPartialsComp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_computes</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">declare_partials</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cs&#39;</span><span class="p">)</span>

        <span class="c1"># turn on dynamic partial coloring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">wrt</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cs&#39;</span><span class="p">,</span> <span class="n">perturb_size</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span>
                              <span class="n">orders</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">show_summary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show_sparsity</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_computes</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="n">SIZE</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">Problem</span><span class="p">()</span>

<span class="n">indeps</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;indeps&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">IndepVarComp</span><span class="p">(),</span> <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>

<span class="c1"># the following were randomly generated using np.random.random(10)*2-1 to randomly</span>
<span class="c1"># disperse them within a unit circle centered at the origin.</span>
<span class="n">indeps</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.55994437</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.95923447</span><span class="p">,</span>  <span class="mf">0.21798656</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02158783</span><span class="p">,</span>  <span class="mf">0.62183717</span><span class="p">,</span>
                                  <span class="mf">0.04007379</span><span class="p">,</span>  <span class="mf">0.46044942</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10129622</span><span class="p">,</span>  <span class="mf">0.27720413</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.37107886</span><span class="p">]))</span>
<span class="n">indeps</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.52577864</span><span class="p">,</span>  <span class="mf">0.30894559</span><span class="p">,</span>  <span class="mf">0.8420792</span> <span class="p">,</span>  <span class="mf">0.35039912</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.67290778</span><span class="p">,</span>
                                  <span class="o">-</span><span class="mf">0.86236787</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.97500023</span><span class="p">,</span>  <span class="mf">0.47739414</span><span class="p">,</span>  <span class="mf">0.51174103</span><span class="p">,</span>  <span class="mf">0.10052582</span><span class="p">]))</span>
<span class="n">indeps</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">)</span>

<span class="c1">########################################################################</span>
<span class="c1"># DynamicPartialsComp is set up to do dynamic partial coloring</span>
<span class="n">arctan_yox</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;arctan_yox&#39;</span><span class="p">,</span> <span class="n">DynamicPartialsComp</span><span class="p">(</span><span class="n">SIZE</span><span class="p">))</span>
<span class="c1">########################################################################</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;circle&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;area=pi*r**2&#39;</span><span class="p">))</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;r_con&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;g=x**2 + y**2 - r&#39;</span><span class="p">,</span> <span class="n">has_diag_partials</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                           <span class="n">g</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="p">)))</span>

<span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;theta_con&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;g = x - theta&#39;</span><span class="p">,</span> <span class="n">has_diag_partials</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                               <span class="n">g</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span>
                                               <span class="n">theta</span><span class="o">=</span><span class="n">thetas</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;delta_theta_con&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;g = even - odd&#39;</span><span class="p">,</span> <span class="n">has_diag_partials</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                     <span class="n">g</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">even</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span>
                                                     <span class="n">odd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="o">//</span><span class="mi">2</span><span class="p">)))</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;l_conx&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;g=x-1&#39;</span><span class="p">,</span> <span class="n">has_diag_partials</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">SIZE</span><span class="p">)))</span>

<span class="n">IND</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">ODD_IND</span> <span class="o">=</span> <span class="n">IND</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># all odd indices</span>
<span class="n">EVEN_IND</span> <span class="o">=</span> <span class="n">IND</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># all even indices</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;circle.r&#39;</span><span class="p">,</span> <span class="s1">&#39;r_con.r&#39;</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;r_con.x&#39;</span><span class="p">,</span> <span class="s1">&#39;arctan_yox.x&#39;</span><span class="p">,</span> <span class="s1">&#39;l_conx.x&#39;</span><span class="p">])</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;r_con.y&#39;</span><span class="p">,</span> <span class="s1">&#39;arctan_yox.y&#39;</span><span class="p">])</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;arctan_yox.g&#39;</span><span class="p">,</span> <span class="s1">&#39;theta_con.x&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;arctan_yox.g&#39;</span><span class="p">,</span> <span class="s1">&#39;delta_theta_con.even&#39;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="n">EVEN_IND</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;arctan_yox.g&#39;</span><span class="p">,</span> <span class="s1">&#39;delta_theta_con.odd&#39;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="n">ODD_IND</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ScipyOptimizeDriver</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SLSQP&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#####################################</span>
<span class="c1"># set up dynamic total coloring here</span>
<span class="n">p</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">show_summary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show_sparsity</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1">#####################################</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># nonlinear constraints</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;r_con.g&#39;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;theta_con.g&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">EVEN_IND</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;delta_theta_con.g&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>

<span class="c1"># this constrains x[0] to be 1 (see definition of l_conx)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;l_conx.g&#39;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,])</span>

<span class="c1"># linear constraint</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">linear</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="s1">&#39;circle.area&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fwd&#39;</span><span class="p">)</span>

<span class="c1"># coloring info will be displayed during run_driver.  The number of colors in the</span>
<span class="c1"># partial coloring of arctan_yox should be 2 and the number of colors in the</span>
<span class="c1"># total coloring should be 5.</span>
<span class="n">p</span><span class="o">.</span><span class="n">run_driver</span><span class="p">()</span>
</pre></div>
</div>
<div class="cell border-box-sizing code_cell rendered"><div class="output_area"><pre>Approx coloring for &#x27;arctan_yox&#x27; (class DynamicPartialsComp)

f.........f......... 0  g
.f.........f........ 1  g
..f.........f....... 2  g
...f.........f...... 3  g
....f.........f..... 4  g
.....f.........f.... 5  g
......f.........f... 6  g
.......f.........f.. 7  g
........f.........f. 8  g
.........f.........f 9  g
|y
          |x

Jacobian shape: (10, 20)  (10.00% nonzero)

FWD solves: 2   REV solves: 0

Total colors vs. total size: 2 vs 20  (90.0% improvement)


Sparsity computed using tolerance: 1e-40
Most common number of zero entries (180 of 200) repeated 39 times out of 40 tolerances tested.

Time to compute sparsity: 0.002546 sec.
Time to compute coloring: 0.000367 sec.
Full total jacobian was computed 3 times, taking 0.023858 seconds.
Total jacobian shape: (22, 21) 

....................f 0  circle.area
f.........f.........f 1  r_con.g
.f.........f........f 2  r_con.g
..f.........f.......f 3  r_con.g
...f.........f......f 4  r_con.g
....f.........f.....f 5  r_con.g
.....f.........f....f 6  r_con.g
......f.........f...f 7  r_con.g
.......f.........f..f 8  r_con.g
........f.........f.f 9  r_con.g
.........f.........ff 10  r_con.g
f.........f.......... 11  theta_con.g
..f.........f........ 12  theta_con.g
....f.........f...... 13  theta_con.g
......f.........f.... 14  theta_con.g
........f.........f.. 15  theta_con.g
ff........ff......... 16  delta_theta_con.g
..ff........ff....... 17  delta_theta_con.g
....ff........ff..... 18  delta_theta_con.g
......ff........ff... 19  delta_theta_con.g
........ff........ff. 20  delta_theta_con.g
f.................... 21  l_conx.g
|indeps.x
          |indeps.y
                    |indeps.r

Jacobian shape: (22, 21)  (13.42% nonzero)

FWD solves: 5   REV solves: 0

Total colors vs. total size: 5 vs 21  (76.2% improvement)


Sparsity computed using tolerance: 1e-25
Most common number of zero entries (400 of 462) repeated 1 times out of 1 tolerances tested.

Time to compute sparsity: 0.023858 sec.
Time to compute coloring: 0.000608 sec.</pre></div></div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;circle.area&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="cell border-box-sizing code_cell rendered"><div class="output_area"><pre>[3.14159265]</pre></div></div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s see how many calls to compute we need to determine partials for arctan_yox.</span>
<span class="c1"># The partial derivatives are all diagonal, so we should be able to cover them using</span>
<span class="c1"># only 2 colors.</span>
<span class="n">start_calls</span> <span class="o">=</span> <span class="n">arctan_yox</span><span class="o">.</span><span class="n">num_computes</span>
<span class="n">arctan_yox</span><span class="o">.</span><span class="n">run_linearize</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">arctan_yox</span><span class="o">.</span><span class="n">num_computes</span> <span class="o">-</span> <span class="n">start_calls</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell border-box-sizing code_cell rendered"><div class="output_area"><pre>2</pre></div></div></div>
<div class="section" id="static-coloring">
<h2>Static Coloring<a class="headerlink" href="#static-coloring" title="Permalink to this headline">¶</a></h2>
<p>Static partial or semi-total derivative coloring is activated by calling the
<code class="code docutils literal notranslate"><span class="pre">use_fixed_coloring</span></code> function on the corresponding component or group, after
calling <code class="code docutils literal notranslate"><span class="pre">declare_coloring</span></code>.</p>
<dl class="method">
<dt>
<code class="descclassname">System.</code><code class="descname">use_fixed_coloring</code><span class="sig-paren">(</span><em>coloring=&lt;object object&gt;</em>, <em>recurse=True</em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/openmdao/core/system.html#System.use_fixed_coloring"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Use a precomputed coloring for this System.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><dl class="first last docutils">
<dt><strong>coloring</strong> <span class="classifier-delimiter">:</span> <span class="classifier">str</span></dt>
<dd><p class="first last">A coloring filename.  If no arg is passed, filename will be determined
automatically.</p>
</dd>
<dt><strong>recurse</strong> <span class="classifier-delimiter">:</span> <span class="classifier">bool</span></dt>
<dd><p class="first last">If True, set fixed coloring in all subsystems that declare a coloring. Ignored
if a specific coloring is passed in.</p>
</dd>
</dl>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Generally, no arg will be passed to <code class="code docutils literal notranslate"><span class="pre">use_fixed_coloring</span></code>, and OpenMDAO will automatically
determine the location and name of the appropriate coloring file, but it is possible to pass
the name of a coloring file into <code class="code docutils literal notranslate"><span class="pre">use_fixed_coloring</span></code>, and in that case the given
coloring file will be used.  Note that if a coloring filename is passed into <code class="code docutils literal notranslate"><span class="pre">use_fixed_coloring</span></code>,
it is assumed that the coloring in that file should <em>never</em> be regenerated, even if the user
calls <code class="code docutils literal notranslate"><span class="pre">openmdao</span> <span class="pre">total_coloring</span></code> or <code class="code docutils literal notranslate"><span class="pre">openmdao</span> <span class="pre">partial_coloring</span></code> from the command line.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../examples/index.html" title="Examples"
             >next</a> |</li>
        <li class="right" >
          <a href="xdsm_visualization.html" title="XDSM generation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenMDAO 2.8.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Features</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Experimental Features</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, openmdao.org.
      Last updated on Aug 08, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>