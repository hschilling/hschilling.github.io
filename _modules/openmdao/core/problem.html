
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>openmdao.core.problem &#8212; OpenMDAO 2.8.0 Beta documentation</title>
    <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/OpenMDAO_Favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenMDAO 2.8.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/OpenMDAO_Logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_guide/index.html">Basic User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_guide/index.html">Advanced User Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features/index.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory_manual/index.html">Theory Manual</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../other/om_command.html">Command Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/citing.html">How to Cite OpenMDAO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/repo_guide/index.html">Building a Tool on Top of OpenMDAO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/api_translation.html">Upgrading from OpenMDAO 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/file_wrap.html">File Wrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_srcdocs/index.html">Source Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_docs/index.html">Developer Docs (if youâ€™re going to contribute code)</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Search OpenMDAO</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="checkbox" name="search_source" /> Include Source Docs
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for openmdao.core.problem</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Define the Problem class and a FakeComm class for non-MPI users.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="k">import</span> <span class="n">fnmatchcase</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">product</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">iterkeys</span><span class="p">,</span> <span class="n">itervalues</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span><span class="p">,</span> <span class="n">cStringIO</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sparse</span>

<span class="kn">from</span> <span class="nn">openmdao.core.component</span> <span class="k">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">openmdao.core.driver</span> <span class="k">import</span> <span class="n">Driver</span>
<span class="kn">from</span> <span class="nn">openmdao.core.explicitcomponent</span> <span class="k">import</span> <span class="n">ExplicitComponent</span>
<span class="kn">from</span> <span class="nn">openmdao.core.group</span> <span class="k">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">openmdao.core.group</span> <span class="k">import</span> <span class="n">System</span>
<span class="kn">from</span> <span class="nn">openmdao.core.indepvarcomp</span> <span class="k">import</span> <span class="n">IndepVarComp</span>
<span class="kn">from</span> <span class="nn">openmdao.core.total_jac</span> <span class="k">import</span> <span class="n">_TotalJacInfo</span>
<span class="kn">from</span> <span class="nn">openmdao.approximation_schemes.complex_step</span> <span class="k">import</span> <span class="n">ComplexStep</span>
<span class="kn">from</span> <span class="nn">openmdao.approximation_schemes.finite_difference</span> <span class="k">import</span> <span class="n">FiniteDifference</span>
<span class="kn">from</span> <span class="nn">openmdao.solvers.solver</span> <span class="k">import</span> <span class="n">SolverInfo</span>
<span class="kn">from</span> <span class="nn">openmdao.error_checking.check_config</span> <span class="k">import</span> <span class="n">_default_checks</span><span class="p">,</span> <span class="n">_all_checks</span>
<span class="kn">from</span> <span class="nn">openmdao.recorders.recording_iteration_stack</span> <span class="k">import</span> <span class="n">_RecIteration</span>
<span class="kn">from</span> <span class="nn">openmdao.recorders.recording_manager</span> <span class="k">import</span> <span class="n">RecordingManager</span><span class="p">,</span> <span class="n">record_viewer_data</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.record_util</span> <span class="k">import</span> <span class="n">create_local_meta</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.general_utils</span> <span class="k">import</span> <span class="n">warn_deprecation</span><span class="p">,</span> <span class="n">ContainsAll</span><span class="p">,</span> <span class="n">pad_name</span><span class="p">,</span> <span class="n">simple_warning</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.mpi</span> <span class="k">import</span> <span class="n">FakeComm</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.mpi</span> <span class="k">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.name_maps</span> <span class="k">import</span> <span class="n">prom_name2abs_name</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.options_dictionary</span> <span class="k">import</span> <span class="n">OptionsDictionary</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.units</span> <span class="k">import</span> <span class="n">get_conversion</span>
<span class="kn">from</span> <span class="nn">openmdao.utils</span> <span class="k">import</span> <span class="n">coloring</span> <span class="k">as</span> <span class="n">coloring_mod</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.name_maps</span> <span class="k">import</span> <span class="n">abs_key2rel_key</span>
<span class="kn">from</span> <span class="nn">openmdao.vectors.default_vector</span> <span class="k">import</span> <span class="n">DefaultVector</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.logger_utils</span> <span class="k">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">TestLogger</span>
<span class="kn">import</span> <span class="nn">openmdao.utils.coloring</span> <span class="k">as</span> <span class="nn">coloring_mod</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">openmdao.vectors.petsc_vector</span> <span class="k">import</span> <span class="n">PETScVector</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PETScVector</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">openmdao.utils.name_maps</span> <span class="k">import</span> <span class="n">rel_key2abs_key</span><span class="p">,</span> <span class="n">rel_name2abs_name</span>

<span class="c1"># Use this as a special value to be able to tell if the caller set a value for the optional</span>
<span class="c1">#   out_stream argument. We run into problems running testflo if we use a default of sys.stdout.</span>
<span class="n">_DEFAULT_OUT_STREAM</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="n">ErrorTuple</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ErrorTuple&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_reverse&#39;</span><span class="p">])</span>
<span class="n">MagnitudeTuple</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;MagnitudeTuple&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse&#39;</span><span class="p">,</span> <span class="s1">&#39;fd&#39;</span><span class="p">])</span>

<span class="n">_contains_all</span> <span class="o">=</span> <span class="n">ContainsAll</span><span class="p">()</span>
<span class="n">_undefined</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="n">CITATION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;@article{openmdao_2019,</span>
<span class="s2">    Author={Justin S. Gray and John T. Hwang and Joaquim R. R. A.</span>
<span class="s2">            Martins and Kenneth T. Moore and Bret A. Naylor},</span>
<span class="s2">    Title=&quot;{OpenMDAO: An Open-Source Framework for Multidisciplinary</span>
<span class="s2">            Design, Analysis, and Optimization}&quot;,</span>
<span class="s2">    Journal=&quot;{Structural and Multidisciplinary Optimization}&quot;,</span>
<span class="s2">    Year=</span><span class="si">{2019}</span><span class="s2">,</span>
<span class="s2">    Publisher=</span><span class="si">{Springer}</span><span class="s2">,</span>
<span class="s2">    pdf={http://openmdao.org/pubs/openmdao_overview_2019.pdf},</span>
<span class="s2">    note= {In Press}</span>
<span class="s2">    }&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Problem"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem">[docs]</a><span class="k">class</span> <span class="nc">Problem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Top-level container for the systems and drivers.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : &lt;System&gt;</span>
<span class="sd">        Pointer to the top-level &lt;System&gt; object (root node in the tree).</span>
<span class="sd">    comm : MPI.Comm or &lt;FakeComm&gt;</span>
<span class="sd">        The global communicator.</span>
<span class="sd">    driver : &lt;Driver&gt;</span>
<span class="sd">        Slot for the driver. The default driver is `Driver`, which just runs</span>
<span class="sd">        the model once.</span>
<span class="sd">    _mode : &#39;fwd&#39; or &#39;rev&#39;</span>
<span class="sd">        Derivatives calculation mode, &#39;fwd&#39; for forward, and &#39;rev&#39; for</span>
<span class="sd">        reverse (adjoint).</span>
<span class="sd">    _orig_mode : &#39;fwd&#39;, &#39;rev&#39;, or &#39;auto&#39;</span>
<span class="sd">        Derivatives calculation mode assigned by the user.  If set to &#39;auto&#39;, _mode will be</span>
<span class="sd">        automatically assigned to &#39;fwd&#39; or &#39;rev&#39; based on relative sizes of design variables vs.</span>
<span class="sd">        responses.</span>
<span class="sd">    _solver_print_cache : list</span>
<span class="sd">        Allows solver iprints to be set to requested values after setup calls.</span>
<span class="sd">    _initial_condition_cache : dict</span>
<span class="sd">        Any initial conditions that are set at the problem level via setitem are cached here</span>
<span class="sd">        until they can be processed.</span>
<span class="sd">    _setup_status : int</span>
<span class="sd">        Current status of the setup in _model.</span>
<span class="sd">        0 -- Newly initialized problem or newly added model.</span>
<span class="sd">        1 -- The `setup` method has been called, but vectors not initialized.</span>
<span class="sd">        2 -- The `final_setup` has been run, everything ready to run.</span>
<span class="sd">    cite : str</span>
<span class="sd">        Listing of relevant citations that should be referenced when</span>
<span class="sd">        publishing work that uses this class.</span>
<span class="sd">    options : &lt;OptionsDictionary&gt;</span>
<span class="sd">        Dictionary with general options for the problem.</span>
<span class="sd">    recording_options : &lt;OptionsDictionary&gt;</span>
<span class="sd">        Dictionary with problem recording options.</span>
<span class="sd">    _rec_mgr : &lt;RecordingManager&gt;</span>
<span class="sd">        Object that manages all recorders added to this problem.</span>
<span class="sd">    _remote_var_set : set</span>
<span class="sd">        Set of variables (absolute names) that require remote data transfer to reach all procs.</span>
<span class="sd">    _check : bool</span>
<span class="sd">        If True, call check_config at the end of final_setup.</span>
<span class="sd">    _recording_iter : _RecIteration</span>
<span class="sd">        Manages recording of iterations.</span>
<span class="sd">    _filtered_vars_to_record : dict</span>
<span class="sd">        Dictionary of lists of design vars, constraints, etc. to record.</span>
<span class="sd">    _logger : object or None</span>
<span class="sd">        Object for logging config checks if _check is True.</span>
<span class="sd">    _force_alloc_complex : bool</span>
<span class="sd">        Force allocation of imaginary part in nonlinear vectors. OpenMDAO can generally</span>
<span class="sd">        detect when you need to do this, but in some cases (e.g., complex step is used</span>
<span class="sd">        after a reconfiguration) you may need to set this to True.</span>
<span class="sd">    _color_dir_hash : str</span>
<span class="sd">        Hash used to detect collisions of coloring files.</span>
<span class="sd">    __get_remote : bool</span>
<span class="sd">        Flag used to determine when __getitem__ will retrieve remote variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_post_setup_func</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Problem.__init__"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize attributes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : &lt;System&gt; or None</span>
<span class="sd">            The top-level &lt;System&gt;. If not specified, an empty &lt;Group&gt; will be created.</span>
<span class="sd">        driver : &lt;Driver&gt; or None</span>
<span class="sd">            The driver for the problem. If not specified, a simple &quot;Run Once&quot; driver will be used.</span>
<span class="sd">        comm : MPI.Comm or &lt;FakeComm&gt; or None</span>
<span class="sd">            The global communicator.</span>
<span class="sd">        root : &lt;System&gt; or None</span>
<span class="sd">            Deprecated kwarg for `model`.</span>
<span class="sd">        **options : named args</span>
<span class="sd">            All remaining named args are converted to options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># used by the get_val function when get_remote is True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_remote</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cite</span> <span class="o">=</span> <span class="n">CITATION</span>

        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
                <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">comm</span> <span class="o">=</span> <span class="n">FakeComm</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both &#39;root&#39; and &#39;model&#39;. &quot;</span>
                                 <span class="s2">&quot;&#39;root&#39; has been deprecated, please use &#39;model&#39;.&quot;</span><span class="p">)</span>

            <span class="n">warn_deprecation</span><span class="p">(</span><span class="s2">&quot;The &#39;root&#39; argument provides backwards compatibility &quot;</span>
                             <span class="s2">&quot;with OpenMDAO &lt;= 1.x ; use &#39;model&#39; instead.&quot;</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">root</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Group</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The value provided for &#39;model&#39; is not a valid System.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">Driver</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">Driver</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The value provided for &#39;driver&#39; is not a valid Driver.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">comm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_solver_print_cache</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># mode is assigned in setup()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_condition_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Status of the setup of _model.</span>
        <span class="c1"># 0 -- Newly initialized problem or newly added model.</span>
        <span class="c1"># 1 -- The `setup` method has been called, but vectors not initialized.</span>
        <span class="c1"># 2 -- The `final_setup` has been run, everything ready to run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_mgr</span> <span class="o">=</span> <span class="n">RecordingManager</span><span class="p">()</span>

        <span class="c1"># General options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">OptionsDictionary</span><span class="p">(</span><span class="n">parent_name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;coloring_dir&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;coloring_files&#39;</span><span class="p">),</span>
                             <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Directory containing coloring files (if any) for this Problem.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Case recording options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span> <span class="o">=</span> <span class="n">OptionsDictionary</span><span class="p">(</span><span class="n">parent_name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;record_desvars&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Set to True to record design variables at the &#39;</span>
                                            <span class="s1">&#39;problem level&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;record_objectives&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Set to True to record objectives at the problem level&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;record_constraints&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Set to True to record constraints at the &#39;</span>
                                            <span class="s1">&#39;problem level&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;includes&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Patterns for variables to include in recording&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;excludes&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Patterns for vars to exclude in recording &#39;</span>
                                            <span class="s1">&#39;(processed post-includes)&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_var_abs_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_abs2meta</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_prom2abs_list</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_prom2abs_list</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_prom2abs_list</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
            <span class="n">abs_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_prom2abs_list</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abs_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">abs_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Using promoted name `</span><span class="si">{}</span><span class="s2">&#39; is ambiguous and matches unconnected &quot;</span>
                               <span class="s2">&quot;inputs </span><span class="si">%s</span><span class="s2">. Use absolute name to disambiguate.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                                                                      <span class="n">abs_names</span><span class="p">))</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

<div class="viewcode-block" id="Problem.is_local"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.is_local">[docs]</a>    <span class="k">def</span> <span class="nf">is_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if the named variable or system is local to the current process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of a variable or system.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the named system or variable is local to this process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;is_local(&#39;</span><span class="si">{}</span><span class="s2">&#39;) was called before setup() completed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">abs_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_var_abs_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_subsystem</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># either the sub is remote or there is no sub by that name</span>
                <span class="c1"># TODO: raise exception if sub does not exist</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if system has been set up, _var_sizes will be initialized</span>
                <span class="k">return</span> <span class="n">sub</span><span class="o">.</span><span class="n">_var_sizes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># variable exists, but may be remote</span>
        <span class="k">return</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_abs2meta</span></div>

<div class="viewcode-block" id="Problem.__getitem__"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.__getitem__">[docs]</a>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an output/input variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Promoted or relative variable name in the root system&#39;s namespace.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or ndarray or any python object</span>
<span class="sd">            the requested output/input variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Caching only needed if vectors aren&#39;t allocated yet.</span>
        <span class="n">proms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_prom2abs_list</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_abs2meta</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">_undefined</span>
        <span class="n">abs_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># We have set and cached already</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_condition_cache</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_condition_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># Vector not setup, so we need to pull values from saved metadata request.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">Group</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_conn_abs_in2out</span><span class="p">:</span>
                        <span class="n">src_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_conn_abs_in2out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">src_name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
                    <span class="n">abs_name</span> <span class="o">=</span> <span class="n">prom_name2abs_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">abs_name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
                    <span class="n">abs_name</span> <span class="o">=</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_conn_abs_in2out</span>
                    <span class="k">if</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">Group</span><span class="p">)</span> <span class="ow">and</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
                            <span class="n">src_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_conn_abs_in2out</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span>
                            <span class="c1"># So, if the inputs and outputs are promoted to the same name, then we</span>
                            <span class="c1"># allow getitem, but if they aren&#39;t, then we raise an error due to non</span>
                            <span class="c1"># uniqueness.</span>
                            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
                                <span class="c1"># This triggers a check for unconnected non-unique inputs, and</span>
                                <span class="c1"># raises the same error as vector access.</span>
                                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">prom_name2abs_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">src_name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># This triggers a check for unconnected non-unique inputs, and</span>
                            <span class="c1"># raises the same error as vector access.</span>
                            <span class="n">abs_name</span> <span class="o">=</span> <span class="n">prom_name2abs_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">abs_name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_undefined</span><span class="p">:</span>
                    <span class="c1"># Need to cache the &quot;get&quot; in case the user calls in-place numpy operations.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_initial_condition_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">prom_name2abs_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>   <span class="c1"># local var</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">_views</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_outputs</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_inputs</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">allprocs_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_abs2meta</span>
            <span class="c1"># check for remote var</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">allprocs_meta</span><span class="p">:</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_var_set</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_remote</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="n">allprocs_meta</span> <span class="ow">and</span> <span class="n">allprocs_meta</span><span class="p">[</span><span class="n">abs_name</span><span class="p">][</span><span class="s1">&#39;distributed&#39;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Retrieval of the full distributed variable &#39;</span><span class="si">%s</span><span class="s2">&#39; is not &quot;</span>
                                           <span class="s2">&quot;supported.&quot;</span> <span class="o">%</span> <span class="n">abs_name</span><span class="p">)</span>
                    <span class="n">loc_val</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_owning_rank</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">owner</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_owning_rank</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">_undefined</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">new_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">owner</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">loc_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">loc_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_undefined</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">loc_val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">new_val</span>
                <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">_undefined</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; is not local to rank </span><span class="si">{}</span><span class="s2">. You can retrieve values from &quot;</span>
                        <span class="s2">&quot;other processes using &quot;</span>
                        <span class="s2">&quot;`problem.get_val(&lt;name&gt;, get_remote=True)`.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">_undefined</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Variable name &quot;</span><span class="si">{}</span><span class="s1">&quot; not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Problem.get_val"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.get_val">[docs]</a>    <span class="k">def</span> <span class="nf">get_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_remote</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an output/input variable.</span>

<span class="sd">        Function is used if you want to specify display units.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Promoted or relative variable name in the root system&#39;s namespace.</span>
<span class="sd">        units : str, optional</span>
<span class="sd">            Units to convert to before upon return.</span>
<span class="sd">        indices : int or list of ints or tuple of ints or int ndarray or Iterable or None, optional</span>
<span class="sd">            Indices or slice to return.</span>
<span class="sd">        get_remote : bool</span>
<span class="sd">            If True, retrieve the value even if it is on a remote process.  Note that if the</span>
<span class="sd">            variable is remote on ANY process, this function must be called on EVERY process</span>
<span class="sd">            in the Problem&#39;s MPI communicator.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or ndarray</span>
<span class="sd">            The requested output/input variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">get_remote</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__get_remote</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__get_remote</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_units</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">base_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t express variable &#39;</span><span class="si">{}</span><span class="s2">&#39; with units of &#39;None&#39; in units of &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">scale</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">get_conversion</span><span class="p">(</span><span class="n">base_units</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t express variable &#39;</span><span class="si">{}</span><span class="s2">&#39; with units of &#39;</span><span class="si">{}</span><span class="s2">&#39; in units of &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">base_units</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>

            <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

        <span class="k">return</span> <span class="n">val</span></div>

    <span class="k">def</span> <span class="nf">_get_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the units for a variable name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Promoted or relative variable name in the root system&#39;s namespace.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Unit string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_abs2meta</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meta</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

        <span class="n">proms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_prom2abs_list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">prom_name2abs_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">meta</span><span class="p">[</span><span class="n">abs_name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proms</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
                <span class="c1"># This triggers a check for unconnected non-unique inputs, and</span>
                <span class="c1"># raises the same error as vector access.</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">prom_name2abs_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">meta</span><span class="p">[</span><span class="n">abs_name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Variable name &quot;</span><span class="si">{}</span><span class="s1">&quot; not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

<div class="viewcode-block" id="Problem.__setitem__"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.__setitem__">[docs]</a>    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an output/input variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Promoted or relative variable name in the root system&#39;s namespace.</span>
<span class="sd">        value : float or ndarray or any python object</span>
<span class="sd">            value to set this variable to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Caching only needed if vectors aren&#39;t allocated yet.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initial_condition_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_proms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_prom2abs_list</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">all_proms</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_proms</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">prom_name2abs_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">abs_name</span> <span class="o">=</span> <span class="n">name</span>

            <span class="k">if</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">_views</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_inputs</span><span class="o">.</span><span class="n">_views</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_outputs</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_discrete_inputs</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># might be a remote var.  If so, just do nothing on this proc</span>
                <span class="k">if</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_abs2meta</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; is remote on rank </span><span class="si">{}</span><span class="s2">.  &quot;</span>
                          <span class="s2">&quot;Local assignment ignored.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Variable name &quot;</span><span class="si">{}</span><span class="s1">&quot; not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Problem.set_val"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.set_val">[docs]</a>    <span class="k">def</span> <span class="nf">set_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an output/input variable.</span>

<span class="sd">        Function is used if you want to set a value using a different unit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Promoted or relative variable name in the root system&#39;s namespace.</span>
<span class="sd">        value : float or ndarray or list</span>
<span class="sd">            Value to set this variable to.</span>
<span class="sd">        units : str, optional</span>
<span class="sd">            Units that value is defined in.</span>
<span class="sd">        indices : int or list of ints or tuple of ints or int ndarray or Iterable or None, optional</span>
<span class="sd">            Indices or slice to set to specified value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_units</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">base_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t set variable &#39;</span><span class="si">{}</span><span class="s2">&#39; with units of &#39;None&#39; to value with units of &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">scale</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">get_conversion</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">base_units</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t set variable &#39;</span><span class="si">{}</span><span class="s2">&#39; with units of &#39;</span><span class="si">{}</span><span class="s2">&#39; to value with units of &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">base_units</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>

            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="nf">_set_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set all initial conditions that have been saved in cache after setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_condition_cache</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Clean up cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_condition_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provide &#39;root&#39; property for backwards compatibility.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &lt;Group&gt;</span>
<span class="sd">            reference to the &#39;model&#39; property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warn_deprecation</span><span class="p">(</span><span class="s2">&quot;The &#39;root&#39; property provides backwards compatibility &quot;</span>
                         <span class="s2">&quot;with OpenMDAO &lt;= 1.x ; use &#39;model&#39; instead.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

    <span class="nd">@root</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provide for setting the &#39;root&#39; property for backwards compatibility.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : &lt;Group&gt;</span>
<span class="sd">            reference to a &lt;Group&gt; to be assigned to the &#39;model&#39; property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warn_deprecation</span><span class="p">(</span><span class="s2">&quot;The &#39;root&#39; property provides backwards compatibility &quot;</span>
                         <span class="s2">&quot;with OpenMDAO &lt;= 1.x ; use &#39;model&#39; instead.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

<div class="viewcode-block" id="Problem.run_model"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.run_model">[docs]</a>    <span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reset_iter_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the model by calling the root system&#39;s solve_nonlinear.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        case_prefix : str or None</span>
<span class="sd">            Prefix to prepend to coordinates when recording.</span>

<span class="sd">        reset_iter_counts : bool</span>
<span class="sd">            If True and model has been run previously, reset all iteration counters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The `setup` method must be called before `run_model`.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">case_prefix</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">case_prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;case_prefix&#39; argument should be a string.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recording_iter</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">case_prefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recording_iter</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">reset_iter_counts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_reset_iter_counts</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">final_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_clear_iprint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">run_solve_nonlinear</span><span class="p">()</span></div>

<div class="viewcode-block" id="Problem.run_driver"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.run_driver">[docs]</a>    <span class="k">def</span> <span class="nf">run_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reset_iter_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the driver on the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        case_prefix : str or None</span>
<span class="sd">            Prefix to prepend to coordinates when recording.</span>

<span class="sd">        reset_iter_counts : bool</span>
<span class="sd">            If True and model has been run previously, reset all iteration counters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        boolean</span>
<span class="sd">            Failure flag; True if failed to converge, False is successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The `setup` method must be called before `run_driver`.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">case_prefix</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">case_prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;case_prefix&#39; argument should be a string.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recording_iter</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">case_prefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recording_iter</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">reset_iter_counts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_reset_iter_counts</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">final_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_clear_iprint</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="Problem.run_once"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backward compatible call for run_model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warn_deprecation</span><span class="p">(</span><span class="s2">&quot;The &#39;run_once&#39; method provides backwards compatibility with &quot;</span>
                         <span class="s2">&quot;OpenMDAO &lt;= 1.x ; use &#39;run_model&#39; instead.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span></div>

<div class="viewcode-block" id="Problem.run"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backward compatible call for run_driver.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        boolean</span>
<span class="sd">            Failure flag; True if failed to converge, False is successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warn_deprecation</span><span class="p">(</span><span class="s2">&quot;The &#39;run&#39; method provides backwards compatibility with &quot;</span>
                         <span class="s2">&quot;OpenMDAO &lt;= 1.x ; use &#39;run_driver&#39; instead.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_driver</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_setup_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up case recording.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_vars_to_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_get_vars_to_record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_mgr</span><span class="o">.</span><span class="n">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Problem.add_recorder"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.add_recorder">[docs]</a>    <span class="k">def</span> <span class="nf">add_recorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recorder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a recorder to the problem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recorder : CaseRecorder</span>
<span class="sd">           A recorder instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_mgr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recorder</span><span class="p">)</span></div>

<div class="viewcode-block" id="Problem.cleanup"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up resources prior to exit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># shut down all recorders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_mgr</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="c1"># clean up driver and model resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">system</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="Problem.record_iteration"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.record_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">record_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record the variables at the Problem level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        case_name : str</span>
<span class="sd">            Name used to identify this Problem case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_mgr</span><span class="o">.</span><span class="n">_recorders</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Get the data to record (collective calls that get across all ranks)</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording_options</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_vars_to_record</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>

        <span class="k">if</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;record_desvars&#39;</span><span class="p">]:</span>
            <span class="n">des_vars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">get_design_var_values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">des_vars</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;record_objectives&#39;</span><span class="p">]:</span>
            <span class="n">obj_vars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">get_objective_values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj_vars</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;record_constraints&#39;</span><span class="p">]:</span>
            <span class="n">con_vars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">get_constraint_values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">con_vars</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">des_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">des_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filt</span><span class="p">[</span><span class="s1">&#39;des&#39;</span><span class="p">]}</span>
        <span class="n">obj_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">obj_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filt</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]}</span>
        <span class="n">con_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">con_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filt</span><span class="p">[</span><span class="s1">&#39;con&#39;</span><span class="p">]}</span>

        <span class="n">names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">_names</span>
        <span class="n">views</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">_views</span>
        <span class="n">sys_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">views</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filt</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">MPI</span><span class="p">:</span>
            <span class="n">des_vars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_gather_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">des_vars</span><span class="p">)</span>
            <span class="n">obj_vars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_gather_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">obj_vars</span><span class="p">)</span>
            <span class="n">con_vars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_gather_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">con_vars</span><span class="p">)</span>
            <span class="n">sys_vars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_gather_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sys_vars</span><span class="p">)</span>

        <span class="n">outs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MPI</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">des_vars</span><span class="p">)</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">obj_vars</span><span class="p">)</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">con_vars</span><span class="p">)</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sys_vars</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;out&#39;</span><span class="p">:</span> <span class="n">outs</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">create_local_meta</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_mgr</span><span class="o">.</span><span class="n">record_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>

<div class="viewcode-block" id="Problem.setup"><a class="viewcode-back" href="../../../features/core_features/running/setup.html#openmdao.core.problem.Problem.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
              <span class="n">force_alloc_complex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distributed_vector_class</span><span class="o">=</span><span class="n">PETScVector</span><span class="p">,</span>
              <span class="n">local_vector_class</span><span class="o">=</span><span class="n">DefaultVector</span><span class="p">,</span> <span class="n">derivatives</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the model hierarchy.</span>

<span class="sd">        When `setup` is called, the model hierarchy is assembled, the processors are allocated</span>
<span class="sd">        (for MPI), and variables and connections are all assigned. This method traverses down</span>
<span class="sd">        the model hierarchy to call `setup` on each subsystem, and then traverses up the model</span>
<span class="sd">        hierarchy to call `configure` on each subsystem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vector_class : type</span>
<span class="sd">            Reference to an actual &lt;Vector&gt; class; not an instance. This is deprecated. Use</span>
<span class="sd">            distributed_vector_class instead.</span>
<span class="sd">        check : boolean</span>
<span class="sd">            whether to run config check after setup is complete.</span>
<span class="sd">        logger : object</span>
<span class="sd">            Object for logging config checks if check is True.</span>
<span class="sd">        mode : string</span>
<span class="sd">            Derivatives calculation mode, &#39;fwd&#39; for forward, and &#39;rev&#39; for</span>
<span class="sd">            reverse (adjoint). Default is &#39;auto&#39;, which will pick &#39;fwd&#39; or &#39;rev&#39; based on</span>
<span class="sd">            the direction resulting in the smallest number of linear solves required to</span>
<span class="sd">            compute derivatives.</span>
<span class="sd">        force_alloc_complex : bool</span>
<span class="sd">            Force allocation of imaginary part in nonlinear vectors. OpenMDAO can generally</span>
<span class="sd">            detect when you need to do this, but in some cases (e.g., complex step is used</span>
<span class="sd">            after a reconfiguration) you may need to set this to True.</span>
<span class="sd">        distributed_vector_class : type</span>
<span class="sd">            Reference to the &lt;Vector&gt; class or factory function used to instantiate vectors</span>
<span class="sd">            and associated transfers involved in interprocess communication.</span>
<span class="sd">        local_vector_class : type</span>
<span class="sd">            Reference to the &lt;Vector&gt; class or factory function used to instantiate vectors</span>
<span class="sd">            and associated transfers involved in intraprocess communication.</span>
<span class="sd">        derivatives : bool</span>
<span class="sd">            If True, perform any memory allocations necessary for derivative computation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : &lt;Problem&gt;</span>
<span class="sd">            this enables the user to instantiate and setup in one line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">force_alloc_complex</span> <span class="o">=</span> <span class="n">force_alloc_complex</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span>

        <span class="k">if</span> <span class="n">vector_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn_deprecation</span><span class="p">(</span><span class="s2">&quot;&#39;vector_class&#39; has been deprecated. Use &quot;</span>
                             <span class="s2">&quot;&#39;distributed_vector_class&#39; and/or &#39;local_vector_class&#39; instead.&quot;</span><span class="p">)</span>
            <span class="n">distributed_vector_class</span> <span class="o">=</span> <span class="n">vector_class</span>

        <span class="c1"># PETScVector is required for MPI</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">PETScVector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempting to run in parallel under MPI but PETScVector could not&quot;</span>
                                 <span class="s2">&quot;be imported.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">distributed_vector_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PETScVector</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The `distributed_vector_class` argument must be `PETScVector` &quot;</span>
                                 <span class="s2">&quot;when running in parallel under MPI but &#39;</span><span class="si">%s</span><span class="s2">&#39; was specified.&quot;</span>
                                 <span class="o">%</span> <span class="n">distributed_vector_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="s1">&#39;rev&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unsupported mode: &#39;</span><span class="si">%s</span><span class="s2">&#39;. Use either &#39;fwd&#39; or &#39;rev&#39;.&quot;</span> <span class="o">%</span> <span class="n">mode</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="c1"># this will be shared by all Solvers in the model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_solver_info</span> <span class="o">=</span> <span class="n">SolverInfo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recording_iter</span> <span class="o">=</span> <span class="n">_RecIteration</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_recording_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording_iter</span>

        <span class="n">model_comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_setup_comm</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">model_comm</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">distributed_vector_class</span><span class="p">,</span> <span class="n">local_vector_class</span><span class="p">,</span>
                     <span class="n">derivatives</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># get set of all vars that we may need to bcast later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_var_set</span> <span class="o">=</span> <span class="n">remote_var_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model_comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">):</span>
                <span class="n">remote_discrete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_sizes</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">][</span><span class="n">type_</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_abs_names</span><span class="p">[</span><span class="n">type_</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sizes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]):</span>
                        <span class="n">remote_var_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_allprocs_discrete</span><span class="p">[</span><span class="n">type_</span><span class="p">]:</span>
                    <span class="n">local</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_discrete</span><span class="p">[</span><span class="n">type_</span><span class="p">])</span>
                    <span class="n">byrank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model_comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">full</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">byrank</span><span class="p">:</span>
                            <span class="n">full</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">byrank</span><span class="p">:</span>
                            <span class="n">diff</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                            <span class="n">remote_discrete</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

                        <span class="n">model_comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">remote_discrete</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remote_discrete</span> <span class="o">=</span> <span class="n">model_comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">remote_var_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">remote_discrete</span><span class="p">)</span>

        <span class="c1"># Cache all args for final setup.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span> <span class="o">=</span> <span class="n">check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_force_alloc_complex</span> <span class="o">=</span> <span class="n">force_alloc_complex</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Problem.final_setup"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.final_setup">[docs]</a>    <span class="k">def</span> <span class="nf">final_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform final setup phase on problem in preparation for run.</span>

<span class="sd">        This is the second phase of setup, and is done automatically at the start of `run_driver`</span>
<span class="sd">        and `run_model`. At the beginning of final_setup, we have a model hierarchy with defined</span>
<span class="sd">        variables, solvers, case_recorders, and derivative settings. During this phase, the vectors</span>
<span class="sd">        are created and populated, the drivers and solvers are initialized, and the recorders are</span>
<span class="sd">        started, and the rest of the framework is prepared for execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>

        <span class="n">response_size</span><span class="p">,</span> <span class="n">desvar_size</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_update_voi_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># update mode if it&#39;s been set to &#39;auto&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;rev&#39;</span> <span class="k">if</span> <span class="n">response_size</span> <span class="o">&lt;</span> <span class="n">desvar_size</span> <span class="k">else</span> <span class="s1">&#39;fwd&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_mode</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_final_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span>
                                    <span class="n">force_alloc_complex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_force_alloc_complex</span><span class="p">)</span>

        <span class="n">driver</span><span class="o">.</span><span class="n">_setup_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">coloring</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="p">[</span><span class="s1">&#39;coloring&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coloring</span> <span class="ow">is</span> <span class="n">coloring_mod</span><span class="o">.</span><span class="n">_STD_COLORING_FNAME</span><span class="p">:</span>
            <span class="n">coloring</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_get_static_coloring</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coloring</span> <span class="ow">and</span> <span class="n">coloring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">coloring_mod</span><span class="o">.</span><span class="n">_DYN_COLORING</span> <span class="ow">and</span>
                <span class="n">coloring_mod</span><span class="o">.</span><span class="n">_use_total_sparsity</span><span class="p">):</span>
            <span class="c1"># if we&#39;re using simultaneous total derivatives then our effective size is less</span>
            <span class="c1"># than the full size</span>
            <span class="k">if</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_fwd</span> <span class="ow">and</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># we&#39;re doing both!</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span> <span class="ow">and</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_fwd</span><span class="p">:</span>
                <span class="n">desvar_size</span> <span class="o">=</span> <span class="n">coloring</span><span class="o">.</span><span class="n">total_solves</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;rev&#39;</span> <span class="ow">and</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
                <span class="n">response_size</span> <span class="o">=</span> <span class="n">coloring</span><span class="o">.</span><span class="n">total_solves</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span> <span class="ow">and</span> <span class="n">desvar_size</span> <span class="o">&gt;</span> <span class="n">response_size</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;rev&#39;</span> <span class="ow">and</span> <span class="n">response_size</span> <span class="o">&gt;</span> <span class="n">desvar_size</span><span class="p">)):</span>
            <span class="n">simple_warning</span><span class="p">(</span><span class="s2">&quot;Inefficient choice of derivative mode.  You chose &#39;</span><span class="si">%s</span><span class="s2">&#39; for a &quot;</span>
                           <span class="s2">&quot;problem with </span><span class="si">%d</span><span class="s2"> design variables and </span><span class="si">%d</span><span class="s2"> response variables &quot;</span>
                           <span class="s2">&quot;(objectives and nonlinear constraints).&quot;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">desvar_size</span><span class="p">,</span> <span class="n">response_size</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="c1"># we only want to set up recording once, after problem setup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">_setup_recording</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_recording</span><span class="p">()</span>
            <span class="n">record_viewer_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Now that setup has been called, we can set the iprints.</span>
        <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_print_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_solver_print</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">depth</span><span class="o">=</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">type_</span><span class="o">=</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver_print_cache</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">checks</span> <span class="o">=</span> <span class="n">_default_checks</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">checks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="n">TestLogger</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="n">checks</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_initial_conditions</span><span class="p">()</span>

        <span class="c1"># check for post-setup hook</span>
        <span class="k">if</span> <span class="n">Problem</span><span class="o">.</span><span class="n">_post_setup_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Problem</span><span class="o">.</span><span class="n">_post_setup_func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Problem.check_partials"><a class="viewcode-back" href="../../../features/core_features/working_with_derivatives/basic_check_partials.html#openmdao.core.problem.Problem.check_partials">[docs]</a>    <span class="k">def</span> <span class="nf">check_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_stream</span><span class="o">=</span><span class="n">_DEFAULT_OUT_STREAM</span><span class="p">,</span> <span class="n">includes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">compact_print</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">abs_err_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">rel_err_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fd&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">step_calc</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span>
                       <span class="n">force_dense</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_only_incorrect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check partial derivatives comprehensively for all components in your model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_stream : file-like object</span>
<span class="sd">            Where to send human readable output. By default it goes to stdout.</span>
<span class="sd">            Set to None to suppress.</span>
<span class="sd">        includes : None or list_like</span>
<span class="sd">            List of glob patterns for pathnames to include in the check. Default is None, which</span>
<span class="sd">            includes all components in the model.</span>
<span class="sd">        excludes : None or list_like</span>
<span class="sd">            List of glob patterns for pathnames to exclude from the check. Default is None, which</span>
<span class="sd">            excludes nothing.</span>
<span class="sd">        compact_print : bool</span>
<span class="sd">            Set to True to just print the essentials, one line per unknown-param pair.</span>
<span class="sd">        abs_err_tol : float</span>
<span class="sd">            Threshold value for absolute error.  Errors about this value will have a &#39;*&#39; displayed</span>
<span class="sd">            next to them in output, making them easy to search for. Default is 1.0E-6.</span>
<span class="sd">        rel_err_tol : float</span>
<span class="sd">            Threshold value for relative error.  Errors about this value will have a &#39;*&#39; displayed</span>
<span class="sd">            next to them in output, making them easy to search for. Note at times there may be a</span>
<span class="sd">            significant relative error due to a minor absolute error.  Default is 1.0E-6.</span>
<span class="sd">        method : str</span>
<span class="sd">            Method, &#39;fd&#39; for finite difference or &#39;cs&#39; for complex step. Default is &#39;fd&#39;.</span>
<span class="sd">        step : float</span>
<span class="sd">            Step size for approximation. Default is None, which means 1e-6 for &#39;fd&#39; and 1e-40 for</span>
<span class="sd">            &#39;cs&#39;.</span>
<span class="sd">        form : string</span>
<span class="sd">            Form for finite difference, can be &#39;forward&#39;, &#39;backward&#39;, or &#39;central&#39;. Default</span>
<span class="sd">            &#39;forward&#39;.</span>
<span class="sd">        step_calc : string</span>
<span class="sd">            Step type for finite difference, can be &#39;abs&#39; for absolute&#39;, or &#39;rel&#39; for relative.</span>
<span class="sd">            Default is &#39;abs&#39;.</span>
<span class="sd">        force_dense : bool</span>
<span class="sd">            If True, analytic derivatives will be coerced into arrays. Default is True.</span>
<span class="sd">        show_only_incorrect : bool, optional</span>
<span class="sd">            Set to True if output should print only the subjacs found to be incorrect.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of dicts of dicts</span>
<span class="sd">            First key:</span>
<span class="sd">                is the component name;</span>
<span class="sd">            Second key:</span>
<span class="sd">                is the (output, input) tuple of strings;</span>
<span class="sd">            Third key:</span>
<span class="sd">                is one of [&#39;rel error&#39;, &#39;abs error&#39;, &#39;magnitude&#39;, &#39;J_fd&#39;, &#39;J_fwd&#39;, &#39;J_rev&#39;];</span>

<span class="sd">            For &#39;rel error&#39;, &#39;abs error&#39;, &#39;magnitude&#39; the value is: A tuple containing norms for</span>
<span class="sd">                forward - fd, adjoint - fd, forward - adjoint.</span>
<span class="sd">            For &#39;J_fd&#39;, &#39;J_fwd&#39;, &#39;J_rev&#39; the value is: A numpy array representing the computed</span>
<span class="sd">                Jacobian for the three different methods of computation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_setup</span><span class="p">()</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_use_derivatives</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t check partials.  Derivative support has been turned off.&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Once we&#39;re tracking iteration counts, run the model if it has not been run before.</span>

        <span class="n">includes</span> <span class="o">=</span> <span class="p">[</span><span class="n">includes</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">includes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">includes</span>
        <span class="n">excludes</span> <span class="o">=</span> <span class="p">[</span><span class="n">excludes</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">excludes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">excludes</span>

        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="n">Component</span><span class="p">,</span> <span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">IndepVarComp</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">pathname</span>

            <span class="c1"># Process includes</span>
            <span class="k">if</span> <span class="n">includes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">includes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fnmatchcase</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="c1"># Process excludes</span>
            <span class="k">if</span> <span class="n">excludes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fnmatchcase</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_solver_print</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># This is a defaultdict of (defaultdict of dicts).</span>
        <span class="n">partials_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>

        <span class="c1"># Caching current point to restore after setups.</span>
        <span class="n">input_cache</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_inputs</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">output_cache</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>

        <span class="c1"># Keep track of derivative keys that are declared dependent so that we don&#39;t print them</span>
        <span class="c1"># unless they are in error.</span>
        <span class="n">indep_key</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Analytic Jacobians</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="s1">&#39;rev&#39;</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_inputs</span><span class="o">.</span><span class="n">set_vec</span><span class="p">(</span><span class="n">input_cache</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">set_vec</span><span class="p">(</span><span class="n">output_cache</span><span class="p">)</span>
            <span class="c1"># Make sure we&#39;re in a valid state</span>
            <span class="n">model</span><span class="o">.</span><span class="n">run_apply_nonlinear</span><span class="p">()</span>

            <span class="n">jac_key</span> <span class="o">=</span> <span class="s1">&#39;J_&#39;</span> <span class="o">+</span> <span class="n">mode</span>

            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>

                <span class="c1"># Only really need to linearize once.</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">run_linearize</span><span class="p">()</span>

                <span class="n">explicit</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">ExplicitComponent</span><span class="p">)</span>
                <span class="n">matrix_free</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">matrix_free</span>
                <span class="n">c_name</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">pathname</span>
                <span class="n">indep_key</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="c1"># TODO: Check deprecated deriv_options.</span>

                <span class="k">with</span> <span class="n">comp</span><span class="o">.</span><span class="n">_unscaled_context</span><span class="p">():</span>

                    <span class="n">of_list</span><span class="p">,</span> <span class="n">wrt_list</span> <span class="o">=</span> \
                        <span class="n">comp</span><span class="o">.</span><span class="n">_get_potential_partials_lists</span><span class="p">(</span><span class="n">include_wrt_outputs</span><span class="o">=</span><span class="ow">not</span> <span class="n">explicit</span><span class="p">)</span>

                    <span class="c1"># Matrix-free components need to calculate their Jacobian by matrix-vector</span>
                    <span class="c1"># product.</span>
                    <span class="k">if</span> <span class="n">matrix_free</span><span class="p">:</span>

                        <span class="n">dstate</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
                            <span class="n">dinputs</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
                            <span class="n">doutputs</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
                            <span class="n">in_list</span> <span class="o">=</span> <span class="n">wrt_list</span>
                            <span class="n">out_list</span> <span class="o">=</span> <span class="n">of_list</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dinputs</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
                            <span class="n">doutputs</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
                            <span class="n">in_list</span> <span class="o">=</span> <span class="n">of_list</span>
                            <span class="n">out_list</span> <span class="o">=</span> <span class="n">wrt_list</span>

                        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">in_list</span><span class="p">:</span>
                            <span class="n">inp_abs</span> <span class="o">=</span> <span class="n">rel_name2abs_name</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">flat_view</span> <span class="o">=</span> <span class="n">dinputs</span><span class="o">.</span><span class="n">_views_flat</span><span class="p">[</span><span class="n">inp_abs</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="c1"># Implicit state</span>
                                <span class="n">flat_view</span> <span class="o">=</span> <span class="n">dstate</span><span class="o">.</span><span class="n">_views_flat</span><span class="p">[</span><span class="n">inp_abs</span><span class="p">]</span>

                            <span class="n">n_in</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_view</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_in</span><span class="p">):</span>

                                <span class="n">dinputs</span><span class="o">.</span><span class="n">set_const</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                                <span class="n">dstate</span><span class="o">.</span><span class="n">set_const</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                                <span class="c1"># Dictionary access returns a scalar for 1d input, and we</span>
                                <span class="c1"># need a vector for clean code, so use _views_flat.</span>
                                <span class="n">flat_view</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                                <span class="c1"># Matrix Vector Product</span>
                                <span class="n">comp</span><span class="o">.</span><span class="n">_apply_linear</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">],</span> <span class="n">_contains_all</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

                                <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                                    <span class="n">out_abs</span> <span class="o">=</span> <span class="n">rel_name2abs_name</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">derivs</span> <span class="o">=</span> <span class="n">doutputs</span><span class="o">.</span><span class="n">_views_flat</span><span class="p">[</span><span class="n">out_abs</span><span class="p">]</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="c1"># Implicit state</span>
                                        <span class="n">derivs</span> <span class="o">=</span> <span class="n">dstate</span><span class="o">.</span><span class="n">_views_flat</span><span class="p">[</span><span class="n">out_abs</span><span class="p">]</span>

                                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
                                        <span class="n">key</span> <span class="o">=</span> <span class="n">out</span><span class="p">,</span> <span class="n">inp</span>
                                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">partials_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

                                        <span class="c1"># Allocate first time</span>
                                        <span class="k">if</span> <span class="n">jac_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deriv</span><span class="p">:</span>
                                            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">derivs</span><span class="p">),</span> <span class="n">n_in</span><span class="p">)</span>
                                            <span class="n">deriv</span><span class="p">[</span><span class="n">jac_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

                                        <span class="n">deriv</span><span class="p">[</span><span class="n">jac_key</span><span class="p">][:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">derivs</span>

                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">key</span> <span class="o">=</span> <span class="n">inp</span><span class="p">,</span> <span class="n">out</span>
                                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">partials_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

                                        <span class="c1"># Allocate first time</span>
                                        <span class="k">if</span> <span class="n">jac_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deriv</span><span class="p">:</span>
                                            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_in</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">derivs</span><span class="p">))</span>
                                            <span class="n">deriv</span><span class="p">[</span><span class="n">jac_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

                                        <span class="n">deriv</span><span class="p">[</span><span class="n">jac_key</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">derivs</span>

                    <span class="c1"># These components already have a Jacobian with calculated derivatives.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subjacs</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_jacobian</span><span class="o">.</span><span class="n">_subjacs_info</span>

                        <span class="k">for</span> <span class="n">rel_key</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">of_list</span><span class="p">,</span> <span class="n">wrt_list</span><span class="p">):</span>
                            <span class="n">abs_key</span> <span class="o">=</span> <span class="n">rel_key2abs_key</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">rel_key</span><span class="p">)</span>
                            <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span> <span class="o">=</span> <span class="n">abs_key</span>

                            <span class="c1"># No need to calculate partials; they are already stored</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">deriv_value</span> <span class="o">=</span> <span class="n">subjacs</span><span class="p">[</span><span class="n">abs_key</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                                <span class="n">rows</span> <span class="o">=</span> <span class="n">subjacs</span><span class="p">[</span><span class="n">abs_key</span><span class="p">][</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">deriv_value</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># Testing for pairs that are not dependent so that we suppress printing</span>
                            <span class="c1"># them unless the fd is non zero. Note: subjacs_info is empty for</span>
                            <span class="c1"># undeclared partials, which is the default behavior now.</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">subjacs</span><span class="p">[</span><span class="n">abs_key</span><span class="p">][</span><span class="s1">&#39;dependent&#39;</span><span class="p">]:</span>
                                    <span class="n">indep_key</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rel_key</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">indep_key</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rel_key</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">deriv_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># Missing derivatives are assumed 0.</span>
                                <span class="n">in_size</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_var_abs2meta</span><span class="p">[</span><span class="n">wrt</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                                <span class="n">out_size</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_var_abs2meta</span><span class="p">[</span><span class="n">of</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                                <span class="n">deriv_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">out_size</span><span class="p">,</span> <span class="n">in_size</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">force_dense</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">in_size</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_var_abs2meta</span><span class="p">[</span><span class="n">wrt</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="n">in_size</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_var_abs2meta</span><span class="p">[</span><span class="n">wrt</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                                    <span class="n">out_size</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_var_abs2meta</span><span class="p">[</span><span class="n">of</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                                    <span class="n">tmp_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">out_size</span><span class="p">,</span> <span class="n">in_size</span><span class="p">))</span>
                                    <span class="c1"># if a scalar value is provided (in declare_partials),</span>
                                    <span class="c1"># expand to the correct size array value for zipping</span>
                                    <span class="k">if</span> <span class="n">deriv_value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">deriv_value</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">subjacs</span><span class="p">[</span><span class="n">abs_key</span><span class="p">][</span><span class="s1">&#39;cols&#39;</span><span class="p">],</span>
                                                         <span class="n">deriv_value</span><span class="p">):</span>
                                        <span class="n">tmp_value</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val</span>
                                    <span class="n">deriv_value</span> <span class="o">=</span> <span class="n">tmp_value</span>

                                <span class="k">elif</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">deriv_value</span><span class="p">):</span>
                                    <span class="n">deriv_value</span> <span class="o">=</span> <span class="n">deriv_value</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>

                            <span class="n">partials_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">rel_key</span><span class="p">][</span><span class="n">jac_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deriv_value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">model</span><span class="o">.</span><span class="n">_inputs</span><span class="o">.</span><span class="n">set_vec</span><span class="p">(</span><span class="n">input_cache</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">set_vec</span><span class="p">(</span><span class="n">output_cache</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">run_apply_nonlinear</span><span class="p">()</span>

        <span class="c1"># Finite Difference to calculate Jacobian</span>
        <span class="n">jac_key</span> <span class="o">=</span> <span class="s1">&#39;J_fd&#39;</span>
        <span class="n">alloc_complex</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">_alloc_complex</span>
        <span class="n">all_fd_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">comps_could_not_cs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">requested_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>

            <span class="n">c_name</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">pathname</span>
            <span class="n">all_fd_options</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">explicit</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">ExplicitComponent</span><span class="p">)</span>

            <span class="n">approximations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fd&#39;</span><span class="p">:</span> <span class="n">FiniteDifference</span><span class="p">(),</span>
                              <span class="s1">&#39;cs&#39;</span><span class="p">:</span> <span class="n">ComplexStep</span><span class="p">()}</span>

            <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_get_potential_partials_lists</span><span class="p">(</span><span class="n">include_wrt_outputs</span><span class="o">=</span><span class="ow">not</span> <span class="n">explicit</span><span class="p">)</span>

            <span class="c1"># Load up approximation objects with the requested settings.</span>
            <span class="n">local_opts</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">_get_check_partial_options</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">rel_key</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">):</span>
                <span class="n">abs_key</span> <span class="o">=</span> <span class="n">rel_key2abs_key</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">rel_key</span><span class="p">)</span>
                <span class="n">local_wrt</span> <span class="o">=</span> <span class="n">rel_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Determine if fd or cs.</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">requested_method</span>
                <span class="k">if</span> <span class="n">local_wrt</span> <span class="ow">in</span> <span class="n">local_opts</span><span class="p">:</span>
                    <span class="n">local_method</span> <span class="o">=</span> <span class="n">local_opts</span><span class="p">[</span><span class="n">local_wrt</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">local_method</span><span class="p">:</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="n">local_method</span>

                <span class="c1"># We can&#39;t use CS if we haven&#39;t allocated a complex vector, so we fall back on fd.</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cs&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">alloc_complex</span><span class="p">:</span>
                    <span class="n">comps_could_not_cs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c_name</span><span class="p">)</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;fd&#39;</span>

                <span class="n">fd_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cs&#39;</span><span class="p">:</span>
                    <span class="n">defaults</span> <span class="o">=</span> <span class="n">ComplexStep</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span>

                    <span class="n">fd_options</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">fd_options</span><span class="p">[</span><span class="s1">&#39;step_calc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;fd&#39;</span><span class="p">:</span>
                    <span class="n">defaults</span> <span class="o">=</span> <span class="n">FiniteDifference</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span>

                    <span class="n">fd_options</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span>
                    <span class="n">fd_options</span><span class="p">[</span><span class="s1">&#39;step_calc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_calc</span>

                <span class="k">if</span> <span class="n">step</span> <span class="ow">and</span> <span class="n">requested_method</span> <span class="o">==</span> <span class="n">method</span><span class="p">:</span>
                    <span class="n">fd_options</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fd_options</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>

                <span class="c1"># Precedence: component options &gt; global options &gt; defaults</span>
                <span class="k">if</span> <span class="n">local_wrt</span> <span class="ow">in</span> <span class="n">local_opts</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;step_calc&#39;</span><span class="p">,</span> <span class="s1">&#39;directional&#39;</span><span class="p">]:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">local_opts</span><span class="p">[</span><span class="n">local_wrt</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">fd_options</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="n">all_fd_options</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">local_wrt</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd_options</span>

                <span class="n">approximations</span><span class="p">[</span><span class="n">fd_options</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add_approximation</span><span class="p">(</span><span class="n">abs_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                       <span class="n">fd_options</span><span class="p">)</span>

            <span class="n">approx_jac</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">approximation</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="n">approximations</span><span class="p">):</span>
                <span class="c1"># Perform the FD here.</span>
                <span class="n">approximation</span><span class="o">.</span><span class="n">compute_approximations</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">approx_jac</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">abs_key</span><span class="p">,</span> <span class="n">partial</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">approx_jac</span><span class="p">):</span>
                <span class="n">rel_key</span> <span class="o">=</span> <span class="n">abs_key2rel_key</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">abs_key</span><span class="p">)</span>
                <span class="n">partials_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">rel_key</span><span class="p">][</span><span class="n">jac_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span>

                <span class="c1"># If this is a directional derivative, convert the analytic to a directional one.</span>
                <span class="n">wrt</span> <span class="o">=</span> <span class="n">rel_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">wrt</span> <span class="ow">in</span> <span class="n">local_opts</span> <span class="ow">and</span> <span class="n">local_opts</span><span class="p">[</span><span class="n">wrt</span><span class="p">][</span><span class="s1">&#39;directional&#39;</span><span class="p">]:</span>
                    <span class="n">deriv</span> <span class="o">=</span> <span class="n">partials_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">rel_key</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;J_fwd&#39;</span><span class="p">,</span> <span class="s1">&#39;J_rev&#39;</span><span class="p">]:</span>
                        <span class="n">deriv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">deriv</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Conversion of defaultdict to dicts</span>
        <span class="n">partials_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp_name</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span> <span class="k">for</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">outer</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">partials_data</span><span class="p">)}</span>

        <span class="k">if</span> <span class="n">out_stream</span> <span class="o">==</span> <span class="n">_DEFAULT_OUT_STREAM</span><span class="p">:</span>
            <span class="n">out_stream</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comps_could_not_cs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The following components requested complex step, but force_alloc_complex &quot;</span> <span class="o">+</span> \
                  <span class="s2">&quot;has not been set to True, so finite difference was used: &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">comps_could_not_cs</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">To enable complex step, specify &#39;force_alloc_complex=True&#39; when calling &quot;</span> <span class="o">+</span> \
                   <span class="s2">&quot;setup on the problem, e.g. &#39;problem.setup(force_alloc_complex=True)&#39;&quot;</span>
            <span class="n">simple_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">_assemble_derivative_data</span><span class="p">(</span><span class="n">partials_data</span><span class="p">,</span> <span class="n">rel_err_tol</span><span class="p">,</span> <span class="n">abs_err_tol</span><span class="p">,</span> <span class="n">out_stream</span><span class="p">,</span>
                                  <span class="n">compact_print</span><span class="p">,</span> <span class="n">comps</span><span class="p">,</span> <span class="n">all_fd_options</span><span class="p">,</span> <span class="n">indep_key</span><span class="o">=</span><span class="n">indep_key</span><span class="p">,</span>
                                  <span class="n">all_comps_provide_jacs</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">,</span>
                                  <span class="n">show_only_incorrect</span><span class="o">=</span><span class="n">show_only_incorrect</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">partials_data</span></div>

<div class="viewcode-block" id="Problem.check_totals"><a class="viewcode-back" href="../../../features/core_features/working_with_derivatives/check_total_derivatives.html#openmdao.core.problem.Problem.check_totals">[docs]</a>    <span class="k">def</span> <span class="nf">check_totals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_stream</span><span class="o">=</span><span class="n">_DEFAULT_OUT_STREAM</span><span class="p">,</span> <span class="n">compact_print</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">driver_scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">abs_err_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">rel_err_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fd&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_calc</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check total derivatives for the model vs. finite difference.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        of : list of variable name strings or None</span>
<span class="sd">            Variables whose derivatives will be computed. Default is None, which</span>
<span class="sd">            uses the driver&#39;s objectives and constraints.</span>
<span class="sd">        wrt : list of variable name strings or None</span>
<span class="sd">            Variables with respect to which the derivatives will be computed.</span>
<span class="sd">            Default is None, which uses the driver&#39;s desvars.</span>
<span class="sd">        out_stream : file-like object</span>
<span class="sd">            Where to send human readable output. By default it goes to stdout.</span>
<span class="sd">            Set to None to suppress.</span>
<span class="sd">        compact_print : bool</span>
<span class="sd">            Set to True to just print the essentials, one line per unknown-param pair.</span>
<span class="sd">        driver_scaling : bool</span>
<span class="sd">            When True, return derivatives that are scaled according to either the adder and scaler</span>
<span class="sd">            or the ref and ref0 values that were specified when add_design_var, add_objective, and</span>
<span class="sd">            add_constraint were called on the model. Default is False, which is unscaled.</span>
<span class="sd">        abs_err_tol : float</span>
<span class="sd">            Threshold value for absolute error.  Errors about this value will have a &#39;*&#39; displayed</span>
<span class="sd">            next to them in output, making them easy to search for. Default is 1.0E-6.</span>
<span class="sd">        rel_err_tol : float</span>
<span class="sd">            Threshold value for relative error.  Errors about this value will have a &#39;*&#39; displayed</span>
<span class="sd">            next to them in output, making them easy to search for. Note at times there may be a</span>
<span class="sd">            significant relative error due to a minor absolute error.  Default is 1.0E-6.</span>
<span class="sd">        method : str</span>
<span class="sd">            Method, &#39;fd&#39; for finite difference or &#39;cs&#39; for complex step. Default is &#39;fd&#39;</span>
<span class="sd">        step : float</span>
<span class="sd">            Step size for approximation. Default is None, which means 1e-6 for &#39;fd&#39; and 1e-40 for</span>
<span class="sd">            &#39;cs&#39;.</span>
<span class="sd">        form : string</span>
<span class="sd">            Form for finite difference, can be &#39;forward&#39;, &#39;backward&#39;, or &#39;central&#39;. Default</span>
<span class="sd">            None, which defaults to &#39;forward&#39; for FD.</span>
<span class="sd">        step_calc : string</span>
<span class="sd">            Step type for finite difference, can be &#39;abs&#39; for absolute&#39;, or &#39;rel&#39; for relative.</span>
<span class="sd">            Default is &#39;abs&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict of Dicts of Tuples of Floats</span>

<span class="sd">            First key:</span>
<span class="sd">                is the (output, input) tuple of strings;</span>
<span class="sd">            Second key:</span>
<span class="sd">                is one of [&#39;rel error&#39;, &#39;abs error&#39;, &#39;magnitude&#39;, &#39;fdstep&#39;];</span>

<span class="sd">            For &#39;rel error&#39;, &#39;abs error&#39;, &#39;magnitude&#39; the value is: A tuple containing norms for</span>
<span class="sd">                forward - fd, adjoint - fd, forward - adjoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;run_model must be called before total derivatives can be checked.&quot;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cs&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">_alloc_complex</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">To enable complex step, specify &#39;force_alloc_complex=True&#39; when calling &quot;</span> <span class="o">+</span> \
                  <span class="s2">&quot;setup on the problem, e.g. &#39;problem.setup(force_alloc_complex=True)&#39;&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># TODO: Once we&#39;re tracking iteration counts, run the model if it has not been run before.</span>

        <span class="c1"># Calculate Total Derivatives</span>
        <span class="n">total_info</span> <span class="o">=</span> <span class="n">_TotalJacInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_format</span><span class="o">=</span><span class="s1">&#39;flat_dict&#39;</span><span class="p">,</span>
                                   <span class="n">driver_scaling</span><span class="o">=</span><span class="n">driver_scaling</span><span class="p">)</span>
        <span class="n">Jcalc</span> <span class="o">=</span> <span class="n">total_info</span><span class="o">.</span><span class="n">compute_totals</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cs&#39;</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">ComplexStep</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">FiniteDifference</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>

        <span class="c1"># Approximate FD</span>
        <span class="n">fd_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;step_calc&#39;</span><span class="p">:</span> <span class="n">step_calc</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_jac</span>
        <span class="n">old_jac</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_jacobian</span>
        <span class="n">old_subjacs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_subjacs_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">model</span><span class="o">.</span><span class="n">approx_totals</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                            <span class="n">step_calc</span><span class="o">=</span><span class="n">step_calc</span> <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="s1">&#39;fd&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">total_info</span> <span class="o">=</span> <span class="n">_TotalJacInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_format</span><span class="o">=</span><span class="s1">&#39;flat_dict&#39;</span><span class="p">,</span> <span class="n">approx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">driver_scaling</span><span class="o">=</span><span class="n">driver_scaling</span><span class="p">)</span>
        <span class="n">Jfd</span> <span class="o">=</span> <span class="n">total_info</span><span class="o">.</span><span class="n">compute_totals_approx</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># reset the _owns_approx_jac flag after approximation is complete.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">approx</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_jacobian</span> <span class="o">=</span> <span class="n">old_jac</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_jac</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_subjacs_info</span> <span class="o">=</span> <span class="n">old_subjacs</span>

        <span class="c1"># Assemble and Return all metrics.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">Jcalc</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;J_fwd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;J_fd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jfd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">fd_args</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fd&#39;</span>

        <span class="k">if</span> <span class="n">out_stream</span> <span class="o">==</span> <span class="n">_DEFAULT_OUT_STREAM</span><span class="p">:</span>
            <span class="n">out_stream</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

        <span class="n">_assemble_derivative_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rel_err_tol</span><span class="p">,</span> <span class="n">abs_err_tol</span><span class="p">,</span> <span class="n">out_stream</span><span class="p">,</span> <span class="n">compact_print</span><span class="p">,</span>
                                  <span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">fd_args</span><span class="p">},</span> <span class="n">totals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Problem.compute_totals"><a class="viewcode-back" href="../../../features/core_features/working_with_derivatives/compute_totals.html#openmdao.core.problem.Problem.compute_totals">[docs]</a>    <span class="k">def</span> <span class="nf">compute_totals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_format</span><span class="o">=</span><span class="s1">&#39;flat_dict&#39;</span><span class="p">,</span> <span class="n">debug_print</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">driver_scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute derivatives of desired quantities with respect to desired inputs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        of : list of variable name strings or None</span>
<span class="sd">            Variables whose derivatives will be computed. Default is None, which</span>
<span class="sd">            uses the driver&#39;s objectives and constraints.</span>
<span class="sd">        wrt : list of variable name strings or None</span>
<span class="sd">            Variables with respect to which the derivatives will be computed.</span>
<span class="sd">            Default is None, which uses the driver&#39;s desvars.</span>
<span class="sd">        return_format : string</span>
<span class="sd">            Format to return the derivatives. Can be either &#39;dict&#39; or &#39;flat_dict&#39;.</span>
<span class="sd">            Default is a &#39;flat_dict&#39;, which returns them in a dictionary whose keys are</span>
<span class="sd">            tuples of form (of, wrt).</span>
<span class="sd">        debug_print : bool</span>
<span class="sd">            Set to True to print out some debug information during linear solve.</span>
<span class="sd">        driver_scaling : bool</span>
<span class="sd">            When True, return derivatives that are scaled according to either the adder and scaler</span>
<span class="sd">            or the ref and ref0 values that were specified when add_design_var, add_objective, and</span>
<span class="sd">            add_constraint were called on the model. Default is False, which is unscaled.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        derivs : object</span>
<span class="sd">            Derivatives in form requested by &#39;return_format&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_status</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_setup</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_jac</span><span class="p">:</span>
            <span class="n">total_info</span> <span class="o">=</span> <span class="n">_TotalJacInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_format</span><span class="p">,</span>
                                       <span class="n">approx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">driver_scaling</span><span class="o">=</span><span class="n">driver_scaling</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">total_info</span><span class="o">.</span><span class="n">compute_totals_approx</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_info</span> <span class="o">=</span> <span class="n">_TotalJacInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_format</span><span class="p">,</span>
                                       <span class="n">debug_print</span><span class="o">=</span><span class="n">debug_print</span><span class="p">,</span> <span class="n">driver_scaling</span><span class="o">=</span><span class="n">driver_scaling</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">total_info</span><span class="o">.</span><span class="n">compute_totals</span><span class="p">()</span></div>

<div class="viewcode-block" id="Problem.set_solver_print"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.set_solver_print">[docs]</a>    <span class="k">def</span> <span class="nf">set_solver_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">1e99</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Control printing for solvers and subsolvers in the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        level : int</span>
<span class="sd">            iprint level. Set to 2 to print residuals each iteration; set to 1</span>
<span class="sd">            to print just the iteration totals; set to 0 to disable all printing</span>
<span class="sd">            except for failures, and set to -1 to disable all printing including failures.</span>
<span class="sd">        depth : int</span>
<span class="sd">            How deep to recurse. For example, you can set this to 0 if you only want</span>
<span class="sd">            to print the top level linear and nonlinear solver messages. Default</span>
<span class="sd">            prints everything.</span>
<span class="sd">        type_ : str</span>
<span class="sd">            Type of solver to set: &#39;LN&#39; for linear, &#39;NL&#39; for nonlinear, or &#39;all&#39; for all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_print_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solver_print_cache</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">level</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">type_</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_set_solver_print</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">type_</span><span class="p">)</span></div>

<div class="viewcode-block" id="Problem.list_problem_vars"><a class="viewcode-back" href="../../../features/debugging/listing_variables.html#openmdao.core.problem.Problem.list_problem_vars">[docs]</a>    <span class="k">def</span> <span class="nf">list_problem_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">show_promoted_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">print_arrays</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">desvar_opts</span><span class="o">=</span><span class="p">[],</span>
                          <span class="n">cons_opts</span><span class="o">=</span><span class="p">[],</span>
                          <span class="n">objs_opts</span><span class="o">=</span><span class="p">[],</span>
                          <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print all design variables and responses (objectives and constraints).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_promoted_name : bool</span>
<span class="sd">            If True, then show the promoted names of the variables.</span>
<span class="sd">        print_arrays : bool, optional</span>
<span class="sd">            When False, in the columnar display, just display norm of any ndarrays with size &gt; 1.</span>
<span class="sd">            The norm is surrounded by vertical bars to indicate that it is a norm.</span>
<span class="sd">            When True, also display full values of the ndarray below the row. Format is affected</span>
<span class="sd">            by the values set with numpy.set_printoptions</span>
<span class="sd">            Default is False.</span>
<span class="sd">        desvar_opts : list of str</span>
<span class="sd">            List of optional columns to be displayed in the desvars table.</span>
<span class="sd">            Allowed values are:</span>
<span class="sd">            [&#39;lower&#39;, &#39;upper&#39;, &#39;ref&#39;, &#39;ref0&#39;, &#39;indices&#39;, &#39;adder&#39;, &#39;scaler&#39;, &#39;parallel_deriv_color&#39;,</span>
<span class="sd">            &#39;vectorize_derivs&#39;, &#39;cache_linear_solution&#39;]</span>
<span class="sd">        cons_opts : list of str</span>
<span class="sd">            List of optional columns to be displayed in the cons table.</span>
<span class="sd">            Allowed values are:</span>
<span class="sd">            [&#39;lower&#39;, &#39;upper&#39;, &#39;equals&#39;, &#39;ref&#39;, &#39;ref0&#39;, &#39;indices&#39;, &#39;index&#39;, &#39;adder&#39;, &#39;scaler&#39;,</span>
<span class="sd">            &#39;linear&#39;, &#39;parallel_deriv_color&#39;, &#39;vectorize_derivs&#39;,</span>
<span class="sd">            &#39;cache_linear_solution&#39;]</span>
<span class="sd">        objs_opts : list of str</span>
<span class="sd">            List of optional columns to be displayed in the objs table.</span>
<span class="sd">            Allowed values are:</span>
<span class="sd">            [&#39;ref&#39;, &#39;ref0&#39;, &#39;indices&#39;, &#39;adder&#39;, &#39;scaler&#39;,</span>
<span class="sd">            &#39;parallel_deriv_color&#39;, &#39;vectorize_derivs&#39;, &#39;cache_linear_solution&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]</span>

        <span class="c1"># Design vars</span>
        <span class="n">desvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_design_vars</span><span class="p">()</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;Design Variables&quot;</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="n">default_col_names</span> <span class="o">+</span> <span class="n">desvar_opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_var_info_table</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="n">desvars</span><span class="p">,</span>
                                   <span class="n">show_promoted_name</span><span class="o">=</span><span class="n">show_promoted_name</span><span class="p">,</span>
                                   <span class="n">print_arrays</span><span class="o">=</span><span class="n">print_arrays</span><span class="p">,</span>
                                   <span class="n">col_spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Constraints</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_constraints</span><span class="p">()</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;Constraints&quot;</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="n">default_col_names</span> <span class="o">+</span> <span class="n">cons_opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_var_info_table</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span> <span class="n">show_promoted_name</span><span class="o">=</span><span class="n">show_promoted_name</span><span class="p">,</span>
                                   <span class="n">print_arrays</span><span class="o">=</span><span class="n">print_arrays</span><span class="p">,</span>
                                   <span class="n">col_spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_objectives</span><span class="p">()</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;Objectives&quot;</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="n">default_col_names</span> <span class="o">+</span> <span class="n">objs_opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_var_info_table</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="n">show_promoted_name</span><span class="o">=</span><span class="n">show_promoted_name</span><span class="p">,</span>
                                   <span class="n">print_arrays</span><span class="o">=</span><span class="n">print_arrays</span><span class="p">,</span>
                                   <span class="n">col_spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write_var_info_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">print_arrays</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">show_promoted_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col_spacing</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a table of information for the data in vars.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        header : str</span>
<span class="sd">            The header line for the table.</span>
<span class="sd">        col_names : list of str</span>
<span class="sd">            List of column labels.</span>
<span class="sd">        vars : OrderedDict</span>
<span class="sd">            Keys are variable names and values are metadata for the variables.</span>
<span class="sd">        print_arrays : bool, optional</span>
<span class="sd">            When False, in the columnar display, just display norm of any ndarrays with size &gt; 1.</span>
<span class="sd">            The norm is surrounded by vertical bars to indicate that it is a norm.</span>
<span class="sd">            When True, also display full values of the ndarray below the row. Format is affected</span>
<span class="sd">            by the values set with numpy.set_printoptions</span>
<span class="sd">            Default is False.</span>
<span class="sd">        show_promoted_name : bool</span>
<span class="sd">            If True, then show the promoted names of the variables.</span>
<span class="sd">        col_spacing : int</span>
<span class="sd">            Number of spaces between columns in the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abs2prom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_abs2prom</span>

        <span class="c1"># Get the values for all the elements in the tables</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col_name</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">show_promoted_name</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">abs2prom</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
                            <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs2prom</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs2prom</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">col_name</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">col_space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">col_spacing</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>

        <span class="c1"># loop through the rows finding the max widths</span>
        <span class="n">max_width</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
            <span class="n">max_width</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="si">{}</span><span class="s1">|&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cell</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="n">max_width</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">max_width</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>

        <span class="c1"># print col headers</span>
        <span class="n">header_div</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">header_col_names</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
            <span class="n">header_div</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">max_width</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">col_space</span>
            <span class="n">header_col_names</span> <span class="o">+=</span> <span class="n">pad_name</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">max_width</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">col_space</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">header_col_names</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">header_div</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># print rows with var info</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">have_array_values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># keep track of which values are arrays</span>
            <span class="n">row_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="si">{}</span><span class="s1">|&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cell</span><span class="p">)))</span>
                    <span class="n">have_array_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="n">row_string</span> <span class="o">+=</span> <span class="n">pad_name</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">max_width</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">col_space</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">row_string</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">print_arrays</span><span class="p">:</span>
                <span class="n">left_column_width</span> <span class="o">=</span> <span class="n">max_width</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">have_array_values</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">left_column_width</span> <span class="o">+</span> <span class="n">col_spacing</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">col_name</span><span class="p">))</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
                    <span class="n">out_str</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                    <span class="n">indented_lines</span> <span class="o">=</span> <span class="p">[(</span><span class="n">left_column_width</span> <span class="o">+</span> <span class="n">col_spacing</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                      <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">out_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indented_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>

<div class="viewcode-block" id="Problem.load_case"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.load_case">[docs]</a>    <span class="k">def</span> <span class="nf">load_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull all input and output variables from a case into the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        case : Case object</span>
<span class="sd">            A Case from a CaseRecorder file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">inputs</span> <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">absolute_names</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_abs_names</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Input variable, &#39;</span><span class="si">{}</span><span class="s2">&#39;, recorded in the case is not &quot;</span>
                                   <span class="s2">&quot;found in the model&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">outputs</span> <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">absolute_names</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_var_abs_names</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Output variable, &#39;</span><span class="si">{}</span><span class="s2">&#39;, recorded in the case is not &quot;</span>
                                   <span class="s2">&quot;found in the model&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Problem.check_config"><a class="viewcode-back" href="../../../_srcdocs/packages/core/problem.html#openmdao.core.problem.Problem.check_config">[docs]</a>    <span class="k">def</span> <span class="nf">check_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;openmdao_checks.out&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform optional error checks on a Problem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        logger : object</span>
<span class="sd">            Logging object.</span>
<span class="sd">        checks : list of str or None</span>
<span class="sd">            List of specific checks to be performed.</span>
<span class="sd">        out_file : str or None</span>
<span class="sd">            If not None, output will be written to this file in addition to stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;check_config&#39;</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="n">out_file</span><span class="p">,</span> <span class="n">use_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_default_checks</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">checks</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">checks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_all_checks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_all_checks</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a recognized check.  Available checks are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_all_checks</span><span class="p">)))</span>
                <span class="k">continue</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checking </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">_all_checks</span><span class="p">[</span><span class="n">c</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_assemble_derivative_data</span><span class="p">(</span><span class="n">derivative_data</span><span class="p">,</span> <span class="n">rel_error_tol</span><span class="p">,</span> <span class="n">abs_error_tol</span><span class="p">,</span> <span class="n">out_stream</span><span class="p">,</span>
                              <span class="n">compact_print</span><span class="p">,</span> <span class="n">system_list</span><span class="p">,</span> <span class="n">global_options</span><span class="p">,</span> <span class="n">totals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">indep_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_comps_provide_jacs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">show_only_incorrect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the relative and absolute errors in the given derivatives and print to the out_stream.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    derivative_data : dict</span>
<span class="sd">        Dictionary containing derivative information keyed by system name.</span>
<span class="sd">    rel_error_tol : float</span>
<span class="sd">        Relative error tolerance.</span>
<span class="sd">    abs_error_tol : float</span>
<span class="sd">        Absolute error tolerance.</span>
<span class="sd">    out_stream : file-like object</span>
<span class="sd">            Where to send human readable output.</span>
<span class="sd">            Set to None to suppress.</span>
<span class="sd">    compact_print : bool</span>
<span class="sd">        If results should be printed verbosely or in a table.</span>
<span class="sd">    system_list : Iterable</span>
<span class="sd">        The systems (in the proper order) that were checked.0</span>
<span class="sd">    global_options : dict</span>
<span class="sd">        Dictionary containing the options for the approximation.</span>
<span class="sd">    totals : bool</span>
<span class="sd">        Set to True if we are doing check_totals to skip a bunch of stuff.</span>
<span class="sd">    indep_key : dict of sets, optional</span>
<span class="sd">        Keyed by component name, contains the of/wrt keys that are declared not dependent.</span>
<span class="sd">    all_comps_provide_jacs : bool, optional</span>
<span class="sd">        Set to True if all components provide a Jacobian (are not matrix-free).</span>
<span class="sd">    show_only_incorrect : bool, optional</span>
<span class="sd">        Set to True if output should print only the subjacs found to be incorrect.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nan</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
    <span class="n">suppress_output</span> <span class="o">=</span> <span class="n">out_stream</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">compact_print</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
            <span class="n">deriv_line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> wrt </span><span class="si">{1}</span><span class="s2"> | </span><span class="si">{2:.4e}</span><span class="s2"> | </span><span class="si">{3:.4e}</span><span class="s2"> | </span><span class="si">{4:.4e}</span><span class="s2"> | </span><span class="si">{5:.4e}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_comps_provide_jacs</span><span class="p">:</span>
                <span class="n">deriv_line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> wrt </span><span class="si">{1}</span><span class="s2"> | </span><span class="si">{2:.4e}</span><span class="s2"> | </span><span class="si">{3}</span><span class="s2"> | </span><span class="si">{4:.4e}</span><span class="s2"> | </span><span class="si">{5:.4e}</span><span class="s2"> | </span><span class="si">{6}</span><span class="s2"> | </span><span class="si">{7}</span><span class="s2">&quot;</span> \
                             <span class="s2">&quot; | </span><span class="si">{8:.4e}</span><span class="s2"> | </span><span class="si">{9}</span><span class="s2"> | </span><span class="si">{10}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deriv_line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> wrt </span><span class="si">{1}</span><span class="s2"> | </span><span class="si">{2:.4e}</span><span class="s2"> | </span><span class="si">{3:.4e}</span><span class="s2"> | </span><span class="si">{4:.4e}</span><span class="s2"> | </span><span class="si">{5:.4e}</span><span class="s2">&quot;</span>

    <span class="c1"># Keep track of the worst subjac in terms of relative error for fwd and rev</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span> <span class="ow">and</span> <span class="n">compact_print</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">totals</span><span class="p">:</span>
        <span class="n">worst_subjac_rel_err</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">worst_subjac</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">totals</span> <span class="ow">and</span> <span class="n">show_only_incorrect</span><span class="p">:</span>
        <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">** Only writing information about components with &#39;</span>
                         <span class="s1">&#39;incorrect Jacobians **</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">system_list</span><span class="p">:</span>

        <span class="n">sys_name</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">pathname</span>
        <span class="n">sys_class_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Match header to appropriate type.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
            <span class="n">sys_type</span> <span class="o">=</span> <span class="s1">&#39;Component&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
            <span class="n">sys_type</span> <span class="o">=</span> <span class="s1">&#39;Group&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">sys_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">derivative_data</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No derivative data found for </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys_type</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">)</span>
            <span class="n">simple_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">derivatives</span> <span class="o">=</span> <span class="n">derivative_data</span><span class="p">[</span><span class="n">sys_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
            <span class="n">sys_name</span> <span class="o">=</span> <span class="s1">&#39;Full Model&#39;</span>

        <span class="c1"># Sorted keys ensures deterministic ordering</span>
        <span class="n">sorted_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">derivatives</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
            <span class="c1"># Need to capture the output of a component&#39;s derivative</span>
            <span class="c1"># info so that it can be used if that component is the</span>
            <span class="c1"># worst subjac. That info is printed at the bottom of all the output</span>
            <span class="n">out_buffer</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="p">()</span>
            <span class="n">num_bad_jacs</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Keep track of number of bad derivative values for each component</span>
            <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                <span class="n">header_str</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys_name</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys_type</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys_class_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_str</span><span class="p">)</span>
                <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys_type</span><span class="p">,</span> <span class="n">sys_class_name</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">compact_print</span><span class="p">:</span>
                <span class="c1"># Error Header</span>
                <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> wrt </span><span class="si">{1}</span><span class="s2"> | </span><span class="si">{2}</span><span class="s2"> | </span><span class="si">{3}</span><span class="s2"> | </span><span class="si">{4}</span><span class="s2"> | </span><span class="si">{5}</span><span class="s2">&quot;</span>\
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;&lt;output&gt;&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                            <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;&lt;variable&gt;&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                            <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;calc mag.&#39;</span><span class="p">),</span>
                            <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;check mag.&#39;</span><span class="p">),</span>
                            <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;a(cal-chk)&#39;</span><span class="p">),</span>
                            <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;r(cal-chk)&#39;</span><span class="p">),</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_width_of</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&#39;&lt;output&gt;&#39;&quot;</span><span class="p">)</span>
                    <span class="n">max_width_wrt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&#39;&lt;variable&gt;&#39;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span> <span class="ow">in</span> <span class="n">sorted_keys</span><span class="p">:</span>
                        <span class="n">max_width_of</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_width_of</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">of</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 2 to include quotes</span>
                        <span class="n">max_width_wrt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_width_wrt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_comps_provide_jacs</span><span class="p">:</span>
                        <span class="n">header</span> <span class="o">=</span> \
                            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> wrt </span><span class="si">{1}</span><span class="s2"> | </span><span class="si">{2}</span><span class="s2"> | </span><span class="si">{3}</span><span class="s2"> | </span><span class="si">{4}</span><span class="s2"> | </span><span class="si">{5}</span><span class="s2"> | </span><span class="si">{6}</span><span class="s2"> | </span><span class="si">{7}</span><span class="s2"> | </span><span class="si">{8}</span><span class="s2"> | </span><span class="si">{9}</span><span class="s2"> | </span><span class="si">{10}</span><span class="s2">&quot;</span> \
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;&lt;output&gt;&#39;</span><span class="p">,</span> <span class="n">max_width_of</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;&lt;variable&gt;&#39;</span><span class="p">,</span> <span class="n">max_width_wrt</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;fwd mag.&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;rev mag.&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;check mag.&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;a(fwd-chk)&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;a(rev-chk)&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;a(fwd-rev)&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;r(fwd-chk)&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;r(rev-chk)&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;r(fwd-rev)&#39;</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> wrt </span><span class="si">{1}</span><span class="s2"> | </span><span class="si">{2}</span><span class="s2"> | </span><span class="si">{3}</span><span class="s2"> | </span><span class="si">{4}</span><span class="s2"> | </span><span class="si">{5}</span><span class="s2">&quot;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;&lt;output&gt;&#39;</span><span class="p">,</span> <span class="n">max_width_of</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;&lt;variable&gt;&#39;</span><span class="p">,</span> <span class="n">max_width_wrt</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;fwd mag.&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;check mag.&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;a(fwd-chk)&#39;</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;r(fwd-chk)&#39;</span><span class="p">),</span>
                            <span class="p">)</span>
                <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                    <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span> <span class="ow">in</span> <span class="n">sorted_keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
                <span class="n">fd_opts</span> <span class="o">=</span> <span class="n">global_options</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fd_opts</span> <span class="o">=</span> <span class="n">global_options</span><span class="p">[</span><span class="n">sys_name</span><span class="p">][</span><span class="n">wrt</span><span class="p">]</span>

            <span class="n">derivative_info</span> <span class="o">=</span> <span class="n">derivatives</span><span class="p">[</span><span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">]</span>
            <span class="n">forward</span> <span class="o">=</span> <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;J_fwd&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">totals</span><span class="p">:</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="n">derivative_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;J_rev&#39;</span><span class="p">)</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;J_fd&#39;</span><span class="p">]</span>

            <span class="n">fwd_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">forward</span> <span class="o">-</span> <span class="n">fd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
                <span class="n">rev_error</span> <span class="o">=</span> <span class="n">fwd_rev_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rev_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">reverse</span> <span class="o">-</span> <span class="n">fd</span><span class="p">)</span>
                <span class="n">fwd_rev_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">forward</span> <span class="o">-</span> <span class="n">reverse</span><span class="p">)</span>

            <span class="n">fwd_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">forward</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
                <span class="n">rev_norm</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rev_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
            <span class="n">fd_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

            <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;abs error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs_err</span> <span class="o">=</span> <span class="n">ErrorTuple</span><span class="p">(</span><span class="n">fwd_error</span><span class="p">,</span> <span class="n">rev_error</span><span class="p">,</span> <span class="n">fwd_rev_error</span><span class="p">)</span>
            <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magnitude</span> <span class="o">=</span> <span class="n">MagnitudeTuple</span><span class="p">(</span><span class="n">fwd_norm</span><span class="p">,</span> <span class="n">rev_norm</span><span class="p">,</span> <span class="n">fd_norm</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fd_norm</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fwd_norm</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;rel error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_err</span> <span class="o">=</span> <span class="n">ErrorTuple</span><span class="p">(</span><span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If fd_norm is zero, let&#39;s use fwd_norm as the divisor for relative</span>
                    <span class="c1"># check. That way we don&#39;t accidentally squelch a legitimate problem.</span>
                    <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
                        <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;rel error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_err</span> <span class="o">=</span> <span class="n">ErrorTuple</span><span class="p">(</span><span class="n">fwd_error</span> <span class="o">/</span> <span class="n">fwd_norm</span><span class="p">,</span>
                                                                            <span class="n">nan</span><span class="p">,</span>
                                                                            <span class="n">nan</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rel_err</span> <span class="o">=</span> <span class="n">ErrorTuple</span><span class="p">(</span><span class="n">fwd_error</span> <span class="o">/</span> <span class="n">fwd_norm</span><span class="p">,</span>
                                             <span class="n">rev_error</span> <span class="o">/</span> <span class="n">fwd_norm</span><span class="p">,</span>
                                             <span class="n">fwd_rev_error</span> <span class="o">/</span> <span class="n">fwd_norm</span><span class="p">)</span>
                        <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;rel error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_err</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
                    <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;rel error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_err</span> <span class="o">=</span> <span class="n">ErrorTuple</span><span class="p">(</span><span class="n">fwd_error</span> <span class="o">/</span> <span class="n">fd_norm</span><span class="p">,</span>
                                                                        <span class="n">nan</span><span class="p">,</span>
                                                                        <span class="n">nan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">derivative_info</span><span class="p">[</span><span class="s1">&#39;rel error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_err</span> <span class="o">=</span> <span class="n">ErrorTuple</span><span class="p">(</span><span class="n">fwd_error</span> <span class="o">/</span> <span class="n">fd_norm</span><span class="p">,</span>
                                                                        <span class="n">rev_error</span> <span class="o">/</span> <span class="n">fd_norm</span><span class="p">,</span>
                                                                        <span class="n">fwd_rev_error</span> <span class="o">/</span> <span class="n">fd_norm</span><span class="p">)</span>

            <span class="c1"># Skip printing the dependent keys if the derivatives are fine.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compact_print</span> <span class="ow">and</span> <span class="n">indep_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rel_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rel_key</span> <span class="ow">in</span> <span class="n">indep_key</span><span class="p">[</span><span class="n">sys_name</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fd_norm</span> <span class="o">&lt;</span> <span class="n">abs_error_tol</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">derivative_data</span><span class="p">[</span><span class="n">sys_name</span><span class="p">][</span><span class="n">rel_key</span><span class="p">]</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
                <span class="n">directional</span> <span class="o">=</span> <span class="n">fd_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;directional&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">compact_print</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                            <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">deriv_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="n">pad_name</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="n">magnitude</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                <span class="n">magnitude</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span>
                                <span class="n">abs_err</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                <span class="n">rel_err</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">abs_err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&gt;=</span> <span class="n">abs_error_tol</span><span class="p">:</span>
                                <span class="n">error_string</span> <span class="o">+=</span> <span class="s1">&#39; &gt;ABS_TOL&#39;</span>
                                <span class="k">break</span>

                        <span class="c1"># See if this component has the greater</span>
                        <span class="c1"># error in the derivative computation</span>
                        <span class="c1"># compared to the other components so far</span>
                        <span class="n">is_worst_subjac</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rel_err</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
                                <span class="c1">#  only 1st and 2d errs</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">worst_subjac_rel_err</span><span class="p">:</span>
                                    <span class="n">worst_subjac_rel_err</span> <span class="o">=</span> <span class="n">error</span>
                                    <span class="n">worst_subjac</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys_type</span><span class="p">,</span> <span class="n">sys_class_name</span><span class="p">,</span> <span class="n">sys_name</span><span class="p">)</span>
                                    <span class="n">is_worst_subjac</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&gt;=</span> <span class="n">rel_error_tol</span><span class="p">:</span>
                                <span class="n">error_string</span> <span class="o">+=</span> <span class="s1">&#39; &gt;REL_TOL&#39;</span>
                                <span class="k">break</span>

                        <span class="k">if</span> <span class="n">error_string</span><span class="p">:</span>  <span class="c1"># Any error string indicates that at least one of the</span>
                            <span class="c1">#  derivative calcs is greater than the rel tolerance</span>
                            <span class="n">num_bad_jacs</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">directional</span><span class="p">:</span>
                                <span class="n">wrt</span> <span class="o">=</span> <span class="s2">&quot;(d)&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">wrt</span>
                                <span class="n">wrt_padded</span> <span class="o">=</span> <span class="n">pad_name</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="n">max_width_wrt</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">wrt_padded</span> <span class="o">=</span> <span class="n">pad_name</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="n">max_width_wrt</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_comps_provide_jacs</span><span class="p">:</span>
                                <span class="n">deriv_info_line</span> <span class="o">=</span> \
                                    <span class="n">deriv_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">pad_name</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">max_width_of</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                        <span class="n">wrt_padded</span><span class="p">,</span>
                                        <span class="n">magnitude</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                        <span class="n">_format_if_not_matrix_free</span><span class="p">(</span>
                                            <span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">,</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">reverse</span><span class="p">),</span>
                                        <span class="n">magnitude</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span>
                                        <span class="n">abs_err</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                        <span class="n">_format_if_not_matrix_free</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">,</span>
                                                                   <span class="n">abs_err</span><span class="o">.</span><span class="n">reverse</span><span class="p">),</span>
                                        <span class="n">_format_if_not_matrix_free</span><span class="p">(</span>
                                            <span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">,</span> <span class="n">abs_err</span><span class="o">.</span><span class="n">forward_reverse</span><span class="p">),</span>
                                        <span class="n">rel_err</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                        <span class="n">_format_if_not_matrix_free</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">,</span>
                                                                   <span class="n">rel_err</span><span class="o">.</span><span class="n">reverse</span><span class="p">),</span>
                                        <span class="n">_format_if_not_matrix_free</span><span class="p">(</span>
                                            <span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">,</span> <span class="n">rel_err</span><span class="o">.</span><span class="n">forward_reverse</span><span class="p">),</span>
                                    <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">deriv_info_line</span> <span class="o">=</span> \
                                    <span class="n">deriv_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">pad_name</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">max_width_of</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                        <span class="n">wrt_padded</span><span class="p">,</span>
                                        <span class="n">magnitude</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                        <span class="n">magnitude</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span>
                                        <span class="n">abs_err</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                        <span class="n">rel_err</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
                                    <span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">show_only_incorrect</span> <span class="ow">or</span> <span class="n">error_string</span><span class="p">:</span>
                                <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">deriv_info_line</span> <span class="o">+</span> <span class="n">error_string</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">is_worst_subjac</span><span class="p">:</span>
                                <span class="n">worst_subjac_line</span> <span class="o">=</span> <span class="n">deriv_info_line</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># not compact print</span>

                    <span class="n">fd_desc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fd_opts</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">],</span> <span class="n">fd_opts</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">])</span>

                    <span class="c1"># Magnitudes</span>
                    <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">directional</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: &#39;</span><span class="si">{}</span><span class="s2">&#39; wrt (d)&#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys_name</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: &#39;</span><span class="si">{}</span><span class="s2">&#39; wrt &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys_name</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">))</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Forward Magnitude : </span><span class="si">{:.6e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">magnitude</span><span class="o">.</span><span class="n">forward</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">totals</span> <span class="ow">and</span> <span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">:</span>
                        <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;    Reverse Magnitude : </span><span class="si">{:.6e}</span><span class="s1">&#39;</span>
                        <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">magnitude</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;         Fd Magnitude : </span><span class="si">{:.6e}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">magnitude</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">fd_desc</span><span class="p">))</span>
                    <span class="c1"># Absolute Errors</span>
                    <span class="k">if</span> <span class="n">totals</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">:</span>
                        <span class="n">error_descs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;(Jfor  - Jfd) &#39;</span><span class="p">,</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_descs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;(Jfor  - Jfd) &#39;</span><span class="p">,</span> <span class="s1">&#39;(Jrev  - Jfd) &#39;</span><span class="p">,</span> <span class="s1">&#39;(Jfor  - Jrev)&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">error</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_err</span><span class="p">,</span> <span class="n">error_descs</span><span class="p">):</span>
                        <span class="n">error_str</span> <span class="o">=</span> <span class="n">_format_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">abs_error_tol</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">error_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                            <span class="n">num_bad_jacs</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Absolute Error </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">error_str</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="c1"># Relative Errors</span>
                    <span class="k">for</span> <span class="n">error</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rel_err</span><span class="p">,</span> <span class="n">error_descs</span><span class="p">):</span>
                        <span class="n">error_str</span> <span class="o">=</span> <span class="n">_format_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">rel_error_tol</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">error_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                            <span class="n">num_bad_jacs</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Relative Error </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">error_str</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">MPI</span> <span class="ow">and</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    MPI Rank </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="c1"># Raw Derivatives</span>
                    <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">directional</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Directional Forward Derivative (Jfor)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Raw Forward Derivative (Jfor)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">forward</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">totals</span> <span class="ow">and</span> <span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">directional</span><span class="p">:</span>
                                <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Directional Reverse Derivative (Jrev)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Raw Reverse Derivative (Jrev)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">directional</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Directional FD Derivative (Jfd)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    Raw FD Derivative (Jfd)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">out_stream</span><span class="p">:</span>
                        <span class="n">out_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; -&#39;</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># End of if compact print if/else</span>
            <span class="c1"># End of if not suppress_output</span>
        <span class="c1"># End of for of, wrt in sorted_keys</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_only_incorrect</span> <span class="ow">or</span> <span class="n">num_bad_jacs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out_stream</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
                <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># End of for system in system_list</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span> <span class="ow">and</span> <span class="n">compact_print</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">totals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">worst_subjac</span><span class="p">:</span>
            <span class="n">worst_subjac_header</span> <span class="o">=</span> \
                <span class="s2">&quot;Sub Jacobian with Largest Relative Error: </span><span class="si">{1}</span><span class="s2"> &#39;</span><span class="si">{2}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">worst_subjac</span><span class="p">)</span>
            <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">worst_subjac_header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">worst_subjac_header</span><span class="p">))</span>
            <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">worst_subjac_header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worst_subjac_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_if_not_matrix_free</span><span class="p">(</span><span class="n">matrix_free</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return string to represent deriv check value in compact display.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix_free : bool</span>
<span class="sd">        If True, then the associated Component is matrix-free.</span>
<span class="sd">    val : float</span>
<span class="sd">        The deriv check value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        String which is the actual value if matrix-free, otherwise &#39;n/a&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">matrix_free</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{0:.4e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pad_name</span><span class="p">(</span><span class="s1">&#39;n/a&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format the error, flagging if necessary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    error : float</span>
<span class="sd">        The absolute or relative error.</span>
<span class="sd">    tol : float</span>
<span class="sd">        Tolerance above which errors are flagged</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Formatted and possibly flagged error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="ow">or</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.6e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.6e}</span><span class="s1"> *&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenMDAO 2.8.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, openmdao.org.
      Last updated on Aug 08, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>