
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>openmdao.utils.coloring &#8212; OpenMDAO 2.8.0 Beta documentation</title>
    <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/OpenMDAO_Favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenMDAO 2.8.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/OpenMDAO_Logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_guide/index.html">Basic User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_guide/index.html">Advanced User Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features/index.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory_manual/index.html">Theory Manual</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../other/om_command.html">Command Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/citing.html">How to Cite OpenMDAO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/repo_guide/index.html">Building a Tool on Top of OpenMDAO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/api_translation.html">Upgrading from OpenMDAO 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other/file_wrap.html">File Wrapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_srcdocs/index.html">Source Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_docs/index.html">Developer Docs (if youâ€™re going to contribute code)</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Search OpenMDAO</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="checkbox" name="search_source" /> Include Source Docs
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for openmdao.utils.coloring</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Routines to compute coloring for use with simultaneous derivatives.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">distutils.version</span> <span class="k">import</span> <span class="n">LooseVersion</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.compressed</span> <span class="k">import</span> <span class="n">get_index_dtype</span>

<span class="kn">from</span> <span class="nn">openmdao.jacobians.jacobian</span> <span class="k">import</span> <span class="n">Jacobian</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.array_utils</span> <span class="k">import</span> <span class="n">array_viz</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.general_utils</span> <span class="k">import</span> <span class="n">simple_warning</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.mpi</span> <span class="k">import</span> <span class="n">MPI</span>


<span class="n">CITATIONS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@article{Coleman+VermaSISC1998,</span>
<span class="s2">  author  = {Thomas F. Coleman and Arun Verma},</span>
<span class="s2">  title   = {The Efficient Computation of Sparse Jacobian Matrices Using Automatic Differentiation},</span>
<span class="s2">  journal = {SIAM Journal of Scientific Computing},</span>
<span class="s2">  year    = 1998,</span>
<span class="s2">  number  = 4,</span>
<span class="s2">  pages   = {1210-1233},</span>
<span class="s2">  month   = 7,</span>
<span class="s2">  volume  = 19</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># If this is True, then IF simul coloring/sparsity is specified, use it.</span>
<span class="c1"># If False, don&#39;t use it regardless.</span>
<span class="c1"># The command line total_coloring and sparsity commands make this False when generating a</span>
<span class="c1"># new coloring and/or sparsity.</span>
<span class="n">_use_total_sparsity</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># If this is True, then IF partial/semi-total coloring is specified, use it.</span>
<span class="c1"># If False, don&#39;t use it regardless.</span>
<span class="c1"># The command line partial_coloring command makes this False when generating a</span>
<span class="c1"># new partial/semi-total coloring.</span>
<span class="n">_use_partial_sparsity</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># If True, ignore use_fixed_coloring if the coloring passed to it is _STD_COLORING_FNAME.</span>
<span class="c1"># This is used when the &#39;openmdao partial_coloring&#39; or &#39;openmdao total_coloring&#39; commands</span>
<span class="c1"># are running, because the intent there is to generate new coloring files.</span>
<span class="n">_force_dyn_coloring</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># used as an indicator that we should automatically name coloring file based on class module</span>
<span class="c1"># path or system pathname</span>
<span class="n">_STD_COLORING_FNAME</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="c1"># used to indicate that we should dynamically generate a coloring</span>
<span class="n">_DYN_COLORING</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="c1"># default values related to the computation of a sparsity matrix</span>
<span class="n">_DEF_COMP_SPARSITY_ARGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;tol&#39;</span><span class="p">:</span> <span class="mf">1e-25</span><span class="p">,</span>
    <span class="s1">&#39;orders&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;num_full_jacs&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;perturb_size&#39;</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>
    <span class="s1">&#39;show_summary&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;show_sparsity&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># numpy versions before 1.12 don&#39;t use the &#39;axis&#39; arg passed to count_nonzero and always</span>
<span class="c1"># return an int instead of an array of ints, so create our own function for those versions.</span>
<span class="k">if</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="s2">&quot;1.12&quot;</span><span class="p">):</span>
    <span class="n">_count_nonzeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_count_nonzeros</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># rows</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">count</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># cols</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">count</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">arr</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">count</span>


<div class="viewcode-block" id="Coloring"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring">[docs]</a><span class="k">class</span> <span class="nc">Coloring</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for all information relevant to a coloring.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    _shape : tuple of int (nrows, ncols)</span>
<span class="sd">        Tuple describing the shape of the sparsity matrix.</span>
<span class="sd">    _nzrows : ndarray of int</span>
<span class="sd">        Row indices of nonzero entries in the full jac sparsity matrix.</span>
<span class="sd">    _nzcols : ndarray of int</span>
<span class="sd">        Column indices of nonzero entries in the full jac sparsity matrix.</span>
<span class="sd">    _pct_nonzero : float</span>
<span class="sd">        If known, percentage of nonzero vs total array entries.</span>
<span class="sd">    _fwd : tuple (col_lists, row_maps) or None</span>
<span class="sd">        Contains lists of grouped columns and nonzero rows for each column for forward coloring.</span>
<span class="sd">    _rev : tuple (col_lists, row_maps) or None</span>
<span class="sd">        Contains lists of grouped columns and nonzero rows for each column for reverse coloring.</span>
<span class="sd">    _col_vars : list of str or None</span>
<span class="sd">        Names of variables corresponding to columns.</span>
<span class="sd">    _col_var_sizes : ndarray or None</span>
<span class="sd">        Sizes of column variables.</span>
<span class="sd">    _row_vars : list of str or None</span>
<span class="sd">        Names of variables corresponding to rows.</span>
<span class="sd">    _row_var_sizes : ndarray or None</span>
<span class="sd">        Sizes of row variables.</span>
<span class="sd">    _meta : dict</span>
<span class="sd">        Dictionary of metadata used to create the coloring.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Coloring.__init__"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">row_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row_var_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">col_var_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize data structures.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sparsity : ndarray</span>
<span class="sd">            Full jacobian sparsity matrix (dense bool form).</span>
<span class="sd">        row_vars : list of str or None</span>
<span class="sd">            Names of variables corresponding to rows.</span>
<span class="sd">        row_var_sizes : ndarray or None</span>
<span class="sd">            Sizes of row variables.</span>
<span class="sd">        col_vars : list of str or None</span>
<span class="sd">            Names of variables corresponding to columns.</span>
<span class="sd">        col_var_sizes : ndarray or None</span>
<span class="sd">            Sizes of column variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># store the nonzero row and column indices if jac sparsity is provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nzrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nzcols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">sparsity</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pct_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span> <span class="o">=</span> <span class="n">row_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span> <span class="o">=</span> <span class="n">row_var_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span> <span class="o">=</span> <span class="n">col_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span> <span class="o">=</span> <span class="n">col_var_sizes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Coloring.color_iter"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.color_iter">[docs]</a>    <span class="k">def</span> <span class="nf">color_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a direction, yield an iterator over column (or row) groups.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        direction : str</span>
<span class="sd">            Derivative direction (&#39;fwd&#39; or &#39;rev&#39;).</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        list of int</span>
<span class="sd">            Lists of column indices (in fwd mode) or row indices (in rev mode).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;rev&#39;</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid direction &#39;</span><span class="si">%s</span><span class="s2">&#39; in color_iter&quot;</span> <span class="o">%</span> <span class="n">direction</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="Coloring.color_nonzero_iter"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.color_nonzero_iter">[docs]</a>    <span class="k">def</span> <span class="nf">color_nonzero_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a direction, yield an iterator over (columns, nz_rows) or (rows, nz_columns).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        direction : str</span>
<span class="sd">            Indicates which coloring subdict (&#39;fwd&#39; or &#39;rev&#39;) to use.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        (column or row groups, nonzero row or column lists)</span>
<span class="sd">            Yields a list of columns/rows and their associated nonzero rows/columns for each</span>
<span class="sd">            color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nz_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_row_col_map</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col_chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_iter</span><span class="p">(</span><span class="n">direction</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">col_chunk</span><span class="p">,</span> <span class="p">[</span><span class="n">nz_rows</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_chunk</span><span class="p">]</span></div>

<div class="viewcode-block" id="Coloring.get_row_col_map"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.get_row_col_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_row_col_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return mapping of nonzero rows to each column (fwd) or nonzeros columns to each row (rev).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        direction : str</span>
<span class="sd">            Indicator of forward mode (&#39;fwd&#39;) or reverse mode (&#39;rev&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of lists of int</span>
<span class="sd">            List where each entry contains list of nonzero rows/cols for the index corresponding</span>
<span class="sd">            to each column/row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;rev&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid direction &#39;</span><span class="si">%s</span><span class="s2">&#39; in get_row_col_map&quot;</span> <span class="o">%</span> <span class="n">direction</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coloring.modes"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.modes">[docs]</a>    <span class="k">def</span> <span class="nf">modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tuple containing the modes included in this coloring.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            Tuple containing some subset of (&#39;fwd&#39;, &#39;rev&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="s1">&#39;rev&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;fwd&#39;</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;rev&#39;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_solves_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return info about the number of colors given the current coloring scheme.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Total size (minimum chosen based on which mode is better).</span>
<span class="sd">        float</span>
<span class="sd">            Total solves.</span>
<span class="sd">        float</span>
<span class="sd">            Number of forward solves.</span>
<span class="sd">        float</span>
<span class="sd">            Number of reverse solves.</span>
<span class="sd">        float</span>
<span class="sd">            Percent improvment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rev_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># nrows</span>
        <span class="n">fwd_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># ncols</span>

        <span class="n">tot_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_solves</span><span class="p">()</span>

        <span class="n">fwd_solves</span> <span class="o">=</span> <span class="n">rev_solves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tot_colors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># no coloring found</span>
            <span class="n">tot_colors</span> <span class="o">=</span> <span class="n">tot_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">rev_size</span><span class="p">,</span> <span class="n">fwd_size</span><span class="p">])</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fwd_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">rev_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span> <span class="k">else</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">fwd_lists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rev_lists</span><span class="p">:</span>
                <span class="n">tot_size</span> <span class="o">=</span> <span class="n">fwd_size</span>
            <span class="k">elif</span> <span class="n">rev_lists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fwd_lists</span><span class="p">:</span>
                <span class="n">tot_size</span> <span class="o">=</span> <span class="n">rev_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tot_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fwd_size</span><span class="p">,</span> <span class="n">rev_size</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fwd_lists</span><span class="p">:</span>
                <span class="n">fwd_solves</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwd_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwd_lists</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">rev_lists</span><span class="p">:</span>
                <span class="n">rev_solves</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_lists</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">tot_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pct</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pct</span> <span class="o">=</span> <span class="p">((</span><span class="n">tot_size</span> <span class="o">-</span> <span class="n">tot_colors</span><span class="p">)</span> <span class="o">/</span> <span class="n">tot_size</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tot_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tot_size</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>

        <span class="k">return</span> <span class="n">tot_size</span><span class="p">,</span> <span class="n">tot_colors</span><span class="p">,</span> <span class="n">fwd_solves</span><span class="p">,</span> <span class="n">rev_solves</span><span class="p">,</span> <span class="n">pct</span>

<div class="viewcode-block" id="Coloring.total_solves"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.total_solves">[docs]</a>    <span class="k">def</span> <span class="nf">total_solves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_fwd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return total number of solves required based on the given coloring info.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        do_fwd : bool</span>
<span class="sd">            If True, add fwd colors to total.</span>
<span class="sd">        do_rev : bool</span>
<span class="sd">            If True, add rev colors to total.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Total number of solves required to compute the jacobian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># lists[0] are the uncolored columns or rows, which are solved individually so</span>
        <span class="c1"># we add all of them, along with the number of remaining lists, where each</span>
        <span class="c1"># sublist is a bunch of columns or rows that are solved together, to get the total colors</span>
        <span class="c1"># (which equals the total number of linear solves).</span>
        <span class="k">if</span> <span class="n">do_fwd</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">:</span>
            <span class="n">row_lists</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_lists</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">do_rev</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
            <span class="n">col_lists</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_lists</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">total</span></div>

<div class="viewcode-block" id="Coloring.load"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.load">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the coloring object from the given pickle file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            Name of file to read from.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Coloring</span>
<span class="sd">            See docstring for Coloring class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coloring.save"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the coloring object to the given stream, creating intermediate dirs if needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            File to save to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">color_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">color_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">color_dir</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t save coloring.  Expected a string for fname but got a </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_config_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the config of this total Coloring vs. the existing driver config.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        driver : Driver</span>
<span class="sd">            Current driver object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">of_names</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_get_ordered_nl_responses</span><span class="p">()</span>
        <span class="n">of_sizes</span> <span class="o">=</span> <span class="n">_get_response_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">of_names</span><span class="p">)</span>
        <span class="n">wrt_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">_designvars</span><span class="p">)</span>
        <span class="n">wrt_sizes</span> <span class="o">=</span> <span class="n">_get_desvar_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">wrt_names</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_check_msgs</span><span class="p">(</span><span class="n">of_names</span><span class="p">,</span> <span class="n">of_sizes</span><span class="p">,</span> <span class="n">wrt_names</span><span class="p">,</span> <span class="n">wrt_sizes</span><span class="p">,</span> <span class="n">driver</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_config_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the config of this partial (or semi-total) Coloring vs. the existing model config.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : System</span>
<span class="sd">            System being colored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the contents (vars and sizes) of the input and output vectors of system</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coloring&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;wrt_patterns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;wrt_patterns&#39;</span><span class="p">]}</span>
        <span class="n">system</span><span class="o">.</span><span class="n">_update_wrt_matches</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">pathname</span><span class="p">:</span>
            <span class="n">wrt_matches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">system</span><span class="o">.</span><span class="n">pathname</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                           <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;wrt_matches_prom&#39;</span><span class="p">]]</span>
            <span class="c1"># for partial and semi-total derivs, convert to promoted names</span>
            <span class="n">ordered_of_info</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_jac_var_info_abs2prom</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_jacobian_of_iter</span><span class="p">())</span>
            <span class="n">ordered_wrt_info</span> <span class="o">=</span> \
                <span class="n">system</span><span class="o">.</span><span class="n">_jac_var_info_abs2prom</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_jacobian_wrt_iter</span><span class="p">(</span><span class="n">wrt_matches</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ordered_of_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_jacobian_of_iter</span><span class="p">())</span>
            <span class="n">ordered_wrt_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_jacobian_wrt_iter</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;wrt_matches&#39;</span><span class="p">]))</span>

        <span class="n">of_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ordered_of_info</span><span class="p">]</span>
        <span class="n">wrt_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ordered_wrt_info</span><span class="p">]</span>

        <span class="n">of_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ordered_of_info</span><span class="p">]</span>
        <span class="n">wrt_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ordered_wrt_info</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_check_msgs</span><span class="p">(</span><span class="n">of_names</span><span class="p">,</span> <span class="n">of_sizes</span><span class="p">,</span> <span class="n">wrt_names</span><span class="p">,</span> <span class="n">wrt_sizes</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_config_check_msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of_names</span><span class="p">,</span> <span class="n">of_sizes</span><span class="p">,</span> <span class="n">wrt_names</span><span class="p">,</span> <span class="n">wrt_sizes</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">msg_suffix</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Make sure you don&#39;t have different problems that have the same coloring &quot;</span>
                      <span class="s2">&quot;directory. Set the coloring directory by setting the value of &quot;</span>
                      <span class="s2">&quot;problem.options[&#39;coloring_dir&#39;].&quot;</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Current coloring configuration does not match the &quot;</span>
               <span class="s2">&quot;configuration of the current model.&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">msginfo</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">of_names</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">:</span>
            <span class="n">of_diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">of_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">of_diff</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   The following row vars were added: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">of_diff</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">of_diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">of_names</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">of_diff</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   The following row vars were removed: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">of_diff</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   The row vars have changed order.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wrt_names</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">:</span>
            <span class="n">wrt_diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">wrt_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wrt_diff</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   The following column vars were added: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">wrt_diff</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wrt_diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">wrt_names</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wrt_diff</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   The following column vars were removed: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">wrt_diff</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   The column vars have changed order.&#39;</span><span class="p">)</span>

        <span class="c1"># check sizes</span>
        <span class="n">changed_sizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">of_names</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">my_sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span><span class="p">,</span> <span class="n">of_sizes</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">my_sz</span> <span class="o">!=</span> <span class="n">sz</span><span class="p">:</span>
                    <span class="n">changed_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">of_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">wrt_names</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">my_sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">,</span> <span class="n">wrt_sizes</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">my_sz</span> <span class="o">!=</span> <span class="n">sz</span><span class="p">:</span>
                    <span class="n">changed_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrt_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">changed_sizes</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   The following variables have changed sizes: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">changed_sizes</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_suffix</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a short summary representation of this coloring.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Brief summary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;bidirectional&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;rev&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;Coloring (direction: </span><span class="si">%s</span><span class="s1">, ncolors: </span><span class="si">%d</span><span class="s1">, shape: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_solves</span><span class="p">(),</span>
                                                                    <span class="n">shape</span><span class="p">)</span>

<div class="viewcode-block" id="Coloring.summary"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a summary of this coloring.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stream : file-like</span>
<span class="sd">            Where the output will go.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Jacobian shape: (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)  (</span><span class="si">%5.2f%%</span><span class="s2"> nonzero)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct_nonzero</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tot_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tot_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tot_size</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simultaneous derivatives can&#39;t improve on the total number of solves &quot;</span>
                  <span class="s2">&quot;required (</span><span class="si">%s</span><span class="s2">) for this configuration&quot;</span> <span class="o">%</span> <span class="n">tot_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tot_size</span><span class="p">,</span> <span class="n">tot_colors</span><span class="p">,</span> <span class="n">fwd_solves</span><span class="p">,</span> <span class="n">rev_solves</span><span class="p">,</span> <span class="n">pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solves_info</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FWD solves: </span><span class="si">%d</span><span class="s2">   REV solves: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fwd_solves</span><span class="p">,</span> <span class="n">rev_solves</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total colors vs. total size: </span><span class="si">%d</span><span class="s2"> vs </span><span class="si">%s</span><span class="s2">  (</span><span class="si">%.1f%%</span><span class="s2"> improvement)&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">tot_colors</span><span class="p">,</span> <span class="n">tot_size</span><span class="p">,</span> <span class="n">pct</span><span class="p">))</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">good_tol</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;good_tol&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">good_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sparsity computed using tolerance: </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;good_tol&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Most common number of zero entries (</span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2">) repeated </span><span class="si">%d</span><span class="s2"> times out of </span><span class="si">%d</span><span class="s2"> &quot;</span>
                  <span class="s2">&quot;tolerances tested.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;zero_entries&#39;</span><span class="p">],</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;J_size&#39;</span><span class="p">],</span>
                                            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;nz_matches&#39;</span><span class="p">],</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;n_tested&#39;</span><span class="p">]))</span>

        <span class="n">sparsity_time</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sparsity_time&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sparsity_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to compute sparsity: </span><span class="si">%f</span><span class="s2"> sec.&quot;</span> <span class="o">%</span> <span class="n">sparsity_time</span><span class="p">)</span>

        <span class="n">coloring_time</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coloring_time&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coloring_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to compute coloring: </span><span class="si">%f</span><span class="s2"> sec.&quot;</span> <span class="o">%</span> <span class="n">coloring_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coloring.display_txt"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.display_txt">[docs]</a>    <span class="k">def</span> <span class="nf">display_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the structure of a boolean array with coloring info for each nonzero value.</span>

<span class="sd">        Forward mode colored nonzeros are denoted by &#39;f&#39;, reverse mode nonzeros by &#39;r&#39;,</span>
<span class="sd">        overlapping nonzeros by &#39;O&#39; and uncolored nonzeros by &#39;x&#39;.  Zeros are denoted by &#39;.&#39;.</span>
<span class="sd">        Note that x&#39;s and O&#39;s should never appear unless there is a bug in the coloring</span>
<span class="sd">        algorithm.</span>

<span class="sd">        If names and sizes of row and column vars are known, print the name of the row var</span>
<span class="sd">        alongside each row and print the names of the column vars, aligned with each column,</span>
<span class="sd">        at the bottom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">shape</span>

        <span class="c1"># array of chars the same size as dense jacobian</span>
        <span class="n">charr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># mark all nonzero entries as &#39;x&#39; initially, so the &#39;x&#39; will be left</span>
        <span class="c1"># if not covered with an &#39;f&#39; or an &#39;r&#39;</span>
        <span class="n">charr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nzrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nzcols</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">:</span>
            <span class="n">full_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">col2row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">col2row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">rows</span> <span class="o">=</span> <span class="n">full_rows</span>
                    <span class="n">charr</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>

        <span class="n">has_overlap</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
            <span class="n">full_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">row2col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="n">row2col</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="n">full_cols</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="c1"># check for any overlapping entries (ones having both a fwd and rev color)</span>
                        <span class="c1"># NOTE: this should never happen unless there&#39;s a bug in the coloring!</span>
                        <span class="k">if</span> <span class="n">charr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
                            <span class="n">charr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;O&#39;</span>  <span class="c1"># mark entry as overlapping</span>
                            <span class="n">has_overlap</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">charr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># we don&#39;t have var name/size info, so just show the unadorned matrix</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">charr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we have var name/size info, so mark rows/cols with their respective variable names</span>
            <span class="n">rowstart</span> <span class="o">=</span> <span class="n">rowend</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">rv</span><span class="p">,</span> <span class="n">rvsize</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span><span class="p">):</span>
                <span class="n">rowend</span> <span class="o">+=</span> <span class="n">rvsize</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowstart</span><span class="p">,</span> <span class="n">rowend</span><span class="p">):</span>
                    <span class="n">colstart</span> <span class="o">=</span> <span class="n">colend</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cvsize</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">):</span>
                        <span class="n">colend</span> <span class="o">+=</span> <span class="n">cvsize</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colstart</span><span class="p">,</span> <span class="n">colend</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">charr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">colstart</span> <span class="o">=</span> <span class="n">colend</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%d</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rv</span><span class="p">))</span>  <span class="c1"># include row variable with each row</span>
                <span class="n">rowstart</span> <span class="o">=</span> <span class="n">rowend</span>

            <span class="c1"># now print the column vars below the matrix, with each one spaced over to line up</span>
            <span class="c1"># with the appropriate starting column of the matrix (&#39;|&#39; marks the start of each var)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">):</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">start</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">size</span>

        <span class="k">if</span> <span class="n">has_overlap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal coloring bug: jacobian has entries where fwd and rev &quot;</span>
                               <span class="s2">&quot;colorings overlap!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coloring.display"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a plot of the sparsity pattern, showing grouping by color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span><span class="p">,</span> <span class="n">patches</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">cm</span>
            <span class="kn">from</span> <span class="nn">matplotlib.artist</span> <span class="k">import</span> <span class="n">getp</span>
            <span class="kn">from</span> <span class="nn">matplotlib.offsetbox</span> <span class="k">import</span> <span class="n">AnchoredText</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matplotlib is not installed so the coloring viewer is not available. The ascii &quot;</span>
                  <span class="s2">&quot;based coloring viewer can be accessed by calling display_txt() on the Coloring &quot;</span>
                  <span class="s2">&quot;object or by using &#39;openmdao view_coloring --jtext &lt;your_coloring_file&gt;&#39; from &quot;</span>
                  <span class="s2">&quot;the command line.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">ncols</span> <span class="o">/</span> <span class="n">nrows</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">tot_size</span><span class="p">,</span> <span class="n">tot_colors</span><span class="p">,</span> <span class="n">fwd_solves</span><span class="p">,</span> <span class="n">rev_solves</span><span class="p">,</span> <span class="n">pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solves_info</span><span class="p">()</span>

        <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="n">nrows</span> <span class="o">&gt;</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">/</span> <span class="n">size</span>
            <span class="n">ysize</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">/</span> <span class="n">mult</span>
            <span class="n">xsize</span> <span class="o">=</span> <span class="n">ysize</span> <span class="o">*</span> <span class="n">aspect_ratio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="n">ncols</span> <span class="o">/</span> <span class="n">size</span>
            <span class="n">xsize</span> <span class="o">=</span> <span class="n">ncols</span> <span class="o">/</span> <span class="n">mult</span>
            <span class="n">ysize</span> <span class="o">=</span> <span class="n">xsize</span> <span class="o">/</span> <span class="n">aspect_ratio</span>

        <span class="n">xsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsize</span><span class="p">))</span>
        <span class="n">ysize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysize</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">))</span>  <span class="c1"># in inches</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="c1"># hide tic marks/labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># map row/col to corresponding var names</span>
            <span class="n">entry_xnames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">entry_ynames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">entry_xcolors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">entry_ycolors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># pick two colors for our checkerboard pattern</span>
            <span class="n">sjcolors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Greys&#39;</span><span class="p">)(</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Greys&#39;</span><span class="p">)(</span><span class="mf">0.4</span><span class="p">)]</span>

            <span class="n">colstart</span> <span class="o">=</span> <span class="n">colend</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cvsize</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">):</span>
                <span class="n">colend</span> <span class="o">+=</span> <span class="n">cvsize</span>
                <span class="n">entry_xnames</span><span class="p">[</span><span class="n">colstart</span><span class="p">:</span><span class="n">colend</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">colstart</span> <span class="o">=</span> <span class="n">colend</span>

            <span class="c1"># we have var name/size info, so mark rows/cols with their respective variable names</span>
            <span class="n">rowstart</span> <span class="o">=</span> <span class="n">rowend</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ridx</span><span class="p">,</span> <span class="n">rvsize</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span><span class="p">):</span>
                <span class="n">rowend</span> <span class="o">+=</span> <span class="n">rvsize</span>
                <span class="n">entry_ynames</span><span class="p">[</span><span class="n">rowstart</span><span class="p">:</span><span class="n">rowend</span><span class="p">]</span> <span class="o">=</span> <span class="n">ridx</span>

                <span class="n">colstart</span> <span class="o">=</span> <span class="n">colend</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">cidx</span><span class="p">,</span> <span class="n">cvsize</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">):</span>
                    <span class="n">colend</span> <span class="o">+=</span> <span class="n">cvsize</span>
                    <span class="c1"># display grid that breaks up the Jacobian into subjacs by variable pairs.</span>
                    <span class="c1"># using (ridx+cidx)%2 will give us a nice checkerboard pattern</span>
                    <span class="n">J</span><span class="p">[</span><span class="n">rowstart</span><span class="p">:</span><span class="n">rowend</span><span class="p">,</span> <span class="n">colstart</span><span class="p">:</span><span class="n">colend</span><span class="p">]</span> <span class="o">=</span> <span class="n">sjcolors</span><span class="p">[(</span><span class="n">ridx</span> <span class="o">+</span> <span class="n">cidx</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">colstart</span> <span class="o">=</span> <span class="n">colend</span>

                <span class="n">rowstart</span> <span class="o">=</span> <span class="n">rowend</span>

            <span class="k">def</span> <span class="nf">on_press</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">==</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">)</span>
                    <span class="n">iy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="o">-</span> <span class="n">ix</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">5</span><span class="p">:</span>
                        <span class="n">ix</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span> <span class="o">-</span> <span class="n">iy</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">5</span><span class="p">:</span>
                        <span class="n">iy</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">iy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iy</span><span class="p">)</span>
                    <span class="n">iy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">iy</span><span class="p">)</span>

                    <span class="c1"># if J[iy, ix] is not one of the background &#39;checkerboard&#39; colors, then it</span>
                    <span class="c1"># must be either forward or reverse colored.</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">==</span> <span class="n">sjcolors</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">==</span> <span class="n">sjcolors</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="n">color_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># display the color number because sometimes certain colormap colors look</span>
                        <span class="c1"># too similar to the eye.</span>
                        <span class="k">if</span> <span class="n">entry_xcolors</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">color_str</span> <span class="o">=</span> <span class="s1">&#39;Color: </span><span class="si">%d</span><span class="s1"> (fwd)&#39;</span> <span class="o">%</span> <span class="n">entry_xcolors</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">color_str</span> <span class="o">=</span> <span class="s1">&#39;Color: </span><span class="si">%d</span><span class="s1"> (rev)&#39;</span> <span class="o">%</span> <span class="n">entry_ycolors</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span>

                    <span class="c1"># because we have potentially really long pathnames, we just print</span>
                    <span class="c1"># the &#39;of&#39; and &#39;wrt&#39; variables to the console instead of trying to display</span>
                    <span class="c1"># them on the plot.</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">J[</span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">]  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">color_str</span><span class="p">),</span>
                          <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">OF:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">[</span><span class="n">entry_ynames</span><span class="p">[</span><span class="n">iy</span><span class="p">]],</span>
                          <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WRT:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">[</span><span class="n">entry_xnames</span><span class="p">[</span><span class="n">ix</span><span class="p">]])</span>

            <span class="k">def</span> <span class="nf">on_resize</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="c1"># set up event handling</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="n">on_press</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;resize_event&#39;</span><span class="p">,</span> <span class="n">on_resize</span><span class="p">)</span>

        <span class="n">color_arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">:</span>
            <span class="c1"># winter is a blue/green color map</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;winter&#39;</span><span class="p">)</span>

            <span class="n">icol</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">full_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">col2row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">col2row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">rows</span> <span class="o">=</span> <span class="n">full_rows</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">icol</span> <span class="o">/</span> <span class="n">fwd_solves</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                        <span class="n">J</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">idx</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># group 0 are uncolored (each col has different color)</span>
                        <span class="n">icol</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">entry_xcolors</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">icol</span>
                <span class="n">icol</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
            <span class="c1"># autumn_r is a red/yellow color map</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;autumn_r&#39;</span><span class="p">)</span>

            <span class="n">icol</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">full_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">row2col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="n">row2col</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="n">full_cols</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">icol</span> <span class="o">/</span> <span class="n">rev_solves</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="n">J</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">idx</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># group 0 are uncolored (each col has different color)</span>
                        <span class="n">icol</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">entry_ycolors</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">icol</span>
                <span class="n">icol</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Jacobian Coloring (</span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2">)</span><span class="se">\n</span><span class="si">%d</span><span class="s2"> fwd colors, </span><span class="si">%d</span><span class="s2"> rev colors &quot;</span>
                     <span class="s2">&quot;(</span><span class="si">%.1f%%</span><span class="s2"> improvement)&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fwd_solves</span><span class="p">,</span> <span class="n">rev_solves</span><span class="p">,</span> <span class="n">pct</span><span class="p">))</span>

        <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Coloring.get_dense_sparsity"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.get_dense_sparsity">[docs]</a>    <span class="k">def</span> <span class="nf">get_dense_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dense bool array representing the full sparsity.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Dense sparsity matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">J</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nzrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nzcols</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">J</span></div>

<div class="viewcode-block" id="Coloring.get_subjac_sparsity"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.get_subjac_sparsity">[docs]</a>    <span class="k">def</span> <span class="nf">get_subjac_sparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the sparsity structure of each subjacobian based on the full jac sparsity.</span>

<span class="sd">        If row/col variables and sizes are not known, returns None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict or None</span>
<span class="sd">            Mapping of (of, wrt) keys to thier corresponding (nzrows, nzcols, shape).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">:</span>
            <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dense_sparsity</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">_jac2subjac_sparsity</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_subjac_sparsity_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">subjac_sparsity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subjac_sparsity</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">subjac_sparsity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Coloring doesn&#39;t have enough info to compute subjac sparsity.&quot;</span><span class="p">)</span>

        <span class="n">ostart</span> <span class="o">=</span> <span class="n">oend</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">of</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">subjac_sparsity</span><span class="p">):</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="n">iend</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="n">tup</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">sub</span><span class="p">)):</span>
                <span class="n">nzrows</span><span class="p">,</span> <span class="n">nzcols</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">tup</span>
                <span class="n">iend</span> <span class="o">+=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">oend</span> <span class="o">+=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">nzrows</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">nzrows</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">nzcols</span><span class="p">),</span> <span class="n">ostart</span><span class="p">,</span> <span class="n">oend</span><span class="p">,</span> <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span><span class="p">)</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">iend</span>
            <span class="n">ostart</span> <span class="o">=</span> <span class="n">oend</span>

<div class="viewcode-block" id="Coloring.get_declare_partials_calls"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.get_declare_partials_calls">[docs]</a>    <span class="k">def</span> <span class="nf">get_declare_partials_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string containing declare_partials() calls based on the subjac sparsity.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            A string containing a declare_partials() call for each nonzero subjac. This</span>
<span class="sd">            string may be cut and pasted into a component&#39;s setup() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">,</span> <span class="n">nzrows</span><span class="p">,</span> <span class="n">nzcols</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjac_sparsity_iter</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    self.declare_partials(of=&#39;</span><span class="si">%s</span><span class="s2">&#39;, wrt=&#39;</span><span class="si">%s</span><span class="s2">&#39;, rows=</span><span class="si">%s</span><span class="s2">, cols=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">wrt</span><span class="p">,</span> <span class="n">nzrows</span><span class="p">,</span> <span class="n">nzcols</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coloring.get_row_var_coloring"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.Coloring.get_row_var_coloring">[docs]</a>    <span class="k">def</span> <span class="nf">get_row_var_coloring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of fwd and rev solves needed for a particular row variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        varname : str</span>
<span class="sd">            Name of the row variable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of forward solves needed for the given variable.</span>
<span class="sd">        int</span>
<span class="sd">            Number of reverse solves needed for the given variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fwd_solves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rev_solves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_var_sizes</span><span class="p">:</span>
            <span class="n">row_slice</span> <span class="o">=</span> <span class="n">col_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_var_sizes</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">+=</span> <span class="n">size</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">varname</span><span class="p">:</span>
                    <span class="n">row_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find variable &#39;</span><span class="si">%s</span><span class="s2">&#39; in coloring.&quot;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>

            <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">subJ</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">row_slice</span><span class="p">,</span> <span class="n">col_slice</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">:</span>
                <span class="n">uncolored</span> <span class="o">=</span> <span class="p">[[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

                <span class="n">colored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">nzrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">color_group</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">uncolored</span><span class="p">,</span> <span class="n">colored</span><span class="p">):</span>
                    <span class="n">subJ</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># if any color in the group has nonzeros in our variable, add a solve</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">color_group</span><span class="p">:</span>
                        <span class="n">J</span><span class="p">[</span><span class="n">nzrows</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">subJ</span><span class="p">):</span>
                        <span class="n">fwd_solves</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">:</span>
                <span class="n">uncolored</span> <span class="o">=</span> <span class="p">[[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">colored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">for</span> <span class="n">color_group</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">uncolored</span><span class="p">,</span> <span class="n">colored</span><span class="p">):</span>
                    <span class="n">subJ</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">J</span><span class="p">[</span><span class="n">color_group</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">subJ</span><span class="p">):</span>
                        <span class="n">rev_solves</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">fwd_solves</span><span class="p">,</span> <span class="n">rev_solves</span></div></div>


<span class="k">def</span> <span class="nf">_order_by_ID</span><span class="p">(</span><span class="n">col_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return columns in order of incidence degree (ID).</span>

<span class="sd">    ID is the number of already colored neighbors (neighbors are dependent columns).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    col_matrix : ndarray</span>
<span class="sd">        Boolean array of column dependencies.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    int</span>
<span class="sd">        Column index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">degrees</span> <span class="o">=</span> <span class="n">_count_nonzeros</span><span class="p">(</span><span class="n">col_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">degrees</span><span class="o">.</span><span class="n">size</span>

    <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># use max degree column as a starting point instead of just choosing a random column</span>
    <span class="c1"># since all have incidence degree of 0 when we start.</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">degrees</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">start</span>

    <span class="n">colored_degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">degrees</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">get_index_dtype</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">degrees</span><span class="p">[</span><span class="n">start</span><span class="p">]))</span>
    <span class="n">colored_degrees</span><span class="p">[</span><span class="n">col_matrix</span><span class="p">[</span><span class="n">start</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">colored_degrees</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ncols</span>  <span class="c1"># ensure that this col will never have max degree again</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">colored_degrees</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">colored_degrees</span><span class="p">[</span><span class="n">col_matrix</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">colored_degrees</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ncols</span>  <span class="c1"># ensure that this col will never have max degree again</span>
        <span class="k">yield</span> <span class="n">col</span>


<span class="k">def</span> <span class="nf">_J2col_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert boolean jacobian sparsity matrix to a column adjacency matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J : ndarray</span>
<span class="sd">        Boolean jacobian sparsity matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Column adjacency matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">col_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncols</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># mark col_matrix entries as True when nonzero row entries make them dependent</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
        <span class="n">nzro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">row</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">nzro</span><span class="p">:</span>
            <span class="n">col_matrix</span><span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="n">nzro</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># zero out diagonal (column is not adjacent to itself)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">col_matrix</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">col_matrix</span>


<span class="k">def</span> <span class="nf">_Jc2col_matrix_direct</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Jc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a partitioned jacobian sparsity matrix to a column adjacency matrix.</span>

<span class="sd">    This creates the column adjacency matrix used for direct jacobian determination</span>
<span class="sd">    as described in Coleman, T.F., Verma, A. (1998) The efficient Computation of Sparse Jacobian</span>
<span class="sd">    Matrices Using Automatic Differentiation. SIAM Journal on Scientific Computing, 19(4),</span>
<span class="sd">    1210-1233.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J : ndarray</span>
<span class="sd">        Boolean jacobian sparsity matrix.</span>
<span class="sd">    Jc : ndarray</span>
<span class="sd">        Boolean sparsity matrix of a partition of J.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Column adjacency matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">Jc</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">col_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncols</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">col_keep</span> <span class="o">=</span> <span class="n">_count_nonzeros</span><span class="p">(</span><span class="n">Jc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># mark col_matrix[col1, col2] as True when Jc[row, col1] is True OR Jc[row, col2] is True</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
        <span class="n">nzro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">col_keep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">nzro</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Jc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">Jc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col2</span><span class="p">]:</span>
                <span class="n">col_matrix</span><span class="p">[</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">col_matrix</span><span class="p">[</span><span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># zero out diagonal (column is not adjacent to itself)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">col_matrix</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">col_matrix</span>


<span class="k">def</span> <span class="nf">_get_full_disjoint_cols</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find sets of disjoint columns in J and their corresponding rows using a col adjacency matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J : ndarray</span>
<span class="sd">        The total jacobian.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of lists of disjoint columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_full_disjoint_col_matrix_cols</span><span class="p">(</span><span class="n">_J2col_matrix</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_full_disjoint_col_matrix_cols</span><span class="p">(</span><span class="n">col_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find sets of disjoint columns in a column intersection matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    col_matrix : ndarray</span>
<span class="sd">        Column intersection matrix</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of lists of disjoint columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">col_matrix</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># -1 indicates that a column has not been colored</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">get_index_dtype</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">ncols</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">_order_by_ID</span><span class="p">(</span><span class="n">col_matrix</span><span class="p">):</span>
        <span class="n">neighbor_colors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">col_matrix</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">color_groups</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighbor_colors</span><span class="p">:</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">colors</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_groups</span><span class="p">)</span>
            <span class="n">color_groups</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">col</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">color_groups</span>


<span class="k">def</span> <span class="nf">_color_partition</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Jpart</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a single directional fwd coloring using partition Jpart.</span>

<span class="sd">    This routine is used to compute a fwd coloring on Jc and a rev coloring on Jr.T.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J : ndarray</span>
<span class="sd">        Dense jacobian sparsity matrix</span>
<span class="sd">    Jpart : ndarray</span>
<span class="sd">        Partition of the jacobian sparsity matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of color groups.  First group is uncolored.</span>
<span class="sd">    list</span>
<span class="sd">        List of nonzero rows for each column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">Jpart</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">col_nonzeros</span> <span class="o">=</span> <span class="n">_count_nonzeros</span><span class="p">(</span><span class="n">Jpart</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">row_nonzeros</span> <span class="o">=</span> <span class="n">_count_nonzeros</span><span class="p">(</span><span class="n">Jpart</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">col_keep</span> <span class="o">=</span> <span class="n">col_nonzeros</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">row_keep</span> <span class="o">=</span> <span class="n">row_nonzeros</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># use this to map indices back to the full J indices.</span>
    <span class="n">idxmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="n">col_keep</span><span class="p">]</span>

    <span class="n">intersection_mat</span> <span class="o">=</span> <span class="n">_Jc2col_matrix_direct</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Jpart</span><span class="p">)</span>
    <span class="n">intersection_mat</span> <span class="o">=</span> <span class="n">intersection_mat</span><span class="p">[</span><span class="n">col_keep</span><span class="p">]</span>
    <span class="n">intersection_mat</span> <span class="o">=</span> <span class="n">intersection_mat</span><span class="p">[:,</span> <span class="n">col_keep</span><span class="p">]</span>

    <span class="n">col_groups</span> <span class="o">=</span> <span class="n">_get_full_disjoint_col_matrix_cols</span><span class="p">(</span><span class="n">intersection_mat</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_groups</span><span class="p">):</span>
        <span class="n">col_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">idxmap</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group</span> <span class="k">if</span> <span class="n">col_keep</span><span class="p">[</span><span class="n">idxmap</span><span class="p">[</span><span class="n">c</span><span class="p">]]])</span>
    <span class="n">col_groups</span> <span class="o">=</span> <span class="n">_split_groups</span><span class="p">(</span><span class="n">col_groups</span><span class="p">)</span>

    <span class="n">col2row</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">idxmap</span><span class="p">:</span>
        <span class="n">col2row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Jpart</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">row_keep</span><span class="p">[</span><span class="n">r</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">col_groups</span><span class="p">,</span> <span class="n">col2row</span><span class="p">]</span>


<div class="viewcode-block" id="MNCO_bidir"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.MNCO_bidir">[docs]</a><span class="k">def</span> <span class="nf">MNCO_bidir</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute bidirectional coloring using Minimum Nonzero Count Order (MNCO).</span>

<span class="sd">    Based on the algorithm found in Coleman, T.F., Verma, A. (1998) The efficient Computation</span>
<span class="sd">    of Sparse Jacobian Matrices Using Automatic Differentiation. SIAM Journal on Scientific</span>
<span class="sd">    Computing, 19(4), 1210-1233.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J : ndarray</span>
<span class="sd">        Dense Jacobian sparsity matrix (boolean)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Coloring</span>
<span class="sd">        See docstring for Coloring class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">coloring</span> <span class="o">=</span> <span class="n">Coloring</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>

    <span class="n">M_col_nonzeros</span> <span class="o">=</span> <span class="n">_count_nonzeros</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">M_row_nonzeros</span> <span class="o">=</span> <span class="n">_count_nonzeros</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">M_rows</span><span class="p">,</span> <span class="n">M_cols</span> <span class="o">=</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_nzrows</span><span class="p">,</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_nzcols</span>

    <span class="n">Jc_rows</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>
    <span class="n">Jr_cols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span>

    <span class="n">row_i</span> <span class="o">=</span> <span class="n">col_i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># partition J into Jc and Jr</span>
    <span class="c1"># We build Jc from bottom up and Jr from right to left.</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">M_row_nonzeros</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">M_col_nonzeros</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

    <span class="n">nnz_r</span> <span class="o">=</span> <span class="n">M_row_nonzeros</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
    <span class="n">nnz_c</span> <span class="o">=</span> <span class="n">M_col_nonzeros</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

    <span class="n">Jc_nz_max</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># max row nonzeros in Jc</span>
    <span class="n">Jr_nz_max</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># max col nonzeros in Jr</span>

    <span class="k">while</span> <span class="n">M_rows</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">M_cols</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Jr_nz_max</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">Jc_nz_max</span><span class="p">,</span> <span class="n">nnz_r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">Jc_nz_max</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">Jr_nz_max</span><span class="p">,</span> <span class="n">nnz_c</span><span class="p">)):</span>
            <span class="n">Jc_rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_cols</span><span class="p">[</span><span class="n">M_rows</span> <span class="o">==</span> <span class="n">r</span><span class="p">]</span>
            <span class="n">Jc_nz_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nnz_r</span><span class="p">,</span> <span class="n">Jc_nz_max</span><span class="p">)</span>

            <span class="n">M_row_nonzeros</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncols</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># make sure we don&#39;t pick this one again</span>
            <span class="n">M_col_nonzeros</span><span class="p">[</span><span class="n">Jc_rows</span><span class="p">[</span><span class="n">r</span><span class="p">]]</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">keep</span> <span class="o">=</span> <span class="n">M_rows</span> <span class="o">!=</span> <span class="n">r</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">M_row_nonzeros</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">M_col_nonzeros</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">nnz_r</span> <span class="o">=</span> <span class="n">M_row_nonzeros</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>

            <span class="n">row_i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Jr_cols</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_rows</span><span class="p">[</span><span class="n">M_cols</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
            <span class="n">Jr_nz_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nnz_c</span><span class="p">,</span> <span class="n">Jr_nz_max</span><span class="p">)</span>

            <span class="n">M_col_nonzeros</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># make sure we don&#39;t pick this one again</span>
            <span class="n">M_row_nonzeros</span><span class="p">[</span><span class="n">Jr_cols</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">keep</span> <span class="o">=</span> <span class="n">M_cols</span> <span class="o">!=</span> <span class="n">c</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">M_row_nonzeros</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">M_col_nonzeros</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">nnz_c</span> <span class="o">=</span> <span class="n">M_col_nonzeros</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

            <span class="n">col_i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">M_rows</span> <span class="o">=</span> <span class="n">M_rows</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
        <span class="n">M_cols</span> <span class="o">=</span> <span class="n">M_cols</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>

    <span class="n">nnz_Jc</span> <span class="o">=</span> <span class="n">nnz_Jr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row_i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Jc</span> <span class="o">=</span> <span class="n">jac</span>
        <span class="c1"># build Jc and do fwd coloring on it</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cols</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Jc_rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Jc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">nnz_Jc</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

        <span class="n">coloring</span><span class="o">.</span><span class="n">_fwd</span> <span class="o">=</span> <span class="n">_color_partition</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Jc</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># reset for use with Jr</span>

    <span class="k">if</span> <span class="n">col_i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Jr</span> <span class="o">=</span> <span class="n">jac</span>
        <span class="c1"># build Jr and do rev coloring</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Jr_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Jr</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">nnz_Jr</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

        <span class="n">coloring</span><span class="o">.</span><span class="n">_rev</span> <span class="o">=</span> <span class="n">_color_partition</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Jr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nnz_Jc</span> <span class="o">+</span> <span class="n">nnz_Jr</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Nonzero mismatch for J vs. Jc and Jr&quot;</span><span class="p">)</span>

    <span class="c1"># check_coloring(J, coloring)</span>

    <span class="n">coloring</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;coloring_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="k">return</span> <span class="n">coloring</span></div>


<span class="k">def</span> <span class="nf">_tol_sweep</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">],</span> <span class="n">orders</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find best tolerance &#39;around&#39; tol to choose nonzero values of arr.</span>

<span class="sd">    Sweeps over tolerances +- &#39;orders&#39; orders of magnitude around tol and picks the most</span>
<span class="sd">    stable one (one corresponding to the most repeated number of nonzero entries).</span>

<span class="sd">    The array &#39;arr&#39; must not contain negative numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr : ndarray</span>
<span class="sd">        The array requiring computation of nonzero values.</span>
<span class="sd">    tol : float</span>
<span class="sd">        Tolerance.  We&#39;ll sweep above and below this by &#39;orders&#39; of magnitude.</span>
<span class="sd">    orders : int</span>
<span class="sd">        Number of orders of magnitude for one direction of our sweep.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Info about the tolerance and how it was determined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">orders</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># skip the sweep. Just use the tolerance given.</span>
        <span class="n">good_tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="n">nz_matches</span> <span class="o">=</span> <span class="n">n_tested</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nzeros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">itol</span> <span class="o">=</span> <span class="n">tol</span> <span class="o">*</span> <span class="mf">10.</span><span class="o">**</span><span class="n">orders</span>
        <span class="n">smallest</span> <span class="o">=</span> <span class="n">tol</span> <span class="o">/</span> <span class="mf">10.</span><span class="o">**</span><span class="n">orders</span>
        <span class="n">n_tested</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">itol</span> <span class="o">&gt;=</span> <span class="n">smallest</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">itol</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="n">itol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nzeros</span> <span class="ow">and</span> <span class="n">nzeros</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                    <span class="n">nzeros</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itol</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nzeros</span><span class="o">.</span><span class="n">append</span><span class="p">(([</span><span class="n">itol</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span>
                <span class="n">n_tested</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">itol</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">1</span>

        <span class="c1"># pick lowest tolerance corresponding to the most repeated number of &#39;zero&#39; entries</span>
        <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nzeros</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nz_matches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">nz_matches</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">itols</span><span class="p">,</span> <span class="n">nz</span> <span class="ow">in</span> <span class="n">sorted_items</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%3.1g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tol</span> <span class="k">for</span> <span class="n">tol</span> <span class="ow">in</span> <span class="n">itols</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">entry</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">nz</span><span class="p">))</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not find more than 1 tolerance to match any number of &quot;</span>
                               <span class="s2">&quot;nonzeros. This indicates that your tolerance sweep of +- </span><span class="si">%d</span><span class="s2"> &quot;</span>
                               <span class="s2">&quot;orders, starting from </span><span class="si">%s</span><span class="s2"> is not big enough.  To get a &#39;stable&#39; &quot;</span>
                               <span class="s2">&quot;sparsity pattern, try re-running with a larger tolerance sweep.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;Nonzeros found for each tolerance: [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst</span><span class="p">)))</span>

        <span class="n">good_tol</span> <span class="o">=</span> <span class="n">sorted_items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tol&#39;</span><span class="p">:</span> <span class="n">tol</span><span class="p">,</span>
        <span class="s1">&#39;orders&#39;</span><span class="p">:</span> <span class="n">orders</span><span class="p">,</span>
        <span class="s1">&#39;good_tol&#39;</span><span class="p">:</span> <span class="n">good_tol</span><span class="p">,</span>
        <span class="s1">&#39;nz_matches&#39;</span><span class="p">:</span> <span class="n">nz_matches</span><span class="p">,</span>
        <span class="s1">&#39;n_tested&#39;</span><span class="p">:</span> <span class="n">n_tested</span><span class="p">,</span>
        <span class="s1">&#39;zero_entries&#39;</span><span class="p">:</span> <span class="n">arr</span><span class="p">[</span><span class="n">arr</span> <span class="o">&lt;=</span> <span class="n">good_tol</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
        <span class="s1">&#39;J_size&#39;</span><span class="p">:</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">info</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_compute_total_coloring_context</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager for computing total jac sparsity for simultaneous coloring.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    top : System</span>
<span class="sd">        Top of the system hierarchy where coloring will be done.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>  <span class="c1"># set seed for consistency</span>

    <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">matrix_free</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: simultaneous coloring does not currently work with matrix free &quot;</span>
                               <span class="s2">&quot;components.&quot;</span> <span class="o">%</span> <span class="n">system</span><span class="o">.</span><span class="n">pathname</span><span class="p">)</span>

        <span class="n">jac</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_assembled_jac</span>
        <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_jacobian</span>
        <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jac</span><span class="o">.</span><span class="n">_randomize</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">yield</span>

    <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_assembled_jac</span>
        <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_jacobian</span>
        <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jac</span><span class="o">.</span><span class="n">_randomize</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_get_bool_total_jac</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">],</span>
                        <span class="n">tol</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">],</span>
                        <span class="n">orders</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">],</span> <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a boolean version of the total jacobian.</span>

<span class="sd">    The jacobian is computed by calculating a total jacobian using _compute_totals &#39;num_full_jacs&#39;</span>
<span class="sd">    times and adding the absolute values of those together, then dividing by &#39;num_full_jacs&#39;,</span>
<span class="sd">    then converting to a boolean array, specifying all entries below a tolerance as False and all</span>
<span class="sd">    others as True.  Prior to calling _compute_totals, all of the partial jacobians in the</span>
<span class="sd">    model are modified so that when any of their subjacobians are assigned a value, that</span>
<span class="sd">    value is populated with positive random numbers in the range [1.0, 2.0).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prob : Problem</span>
<span class="sd">        The Problem being analyzed.</span>
<span class="sd">    num_full_jacs : int</span>
<span class="sd">        Number of times to repeat total jacobian computation.</span>
<span class="sd">    tol : float</span>
<span class="sd">        Starting tolerance on values in jacobian.  Actual tolerance is computed based on</span>
<span class="sd">        consistent numbers of zero entries over a sweep of tolerances.  Anything smaller in</span>
<span class="sd">        magnitude than the computed tolerance will be set to 0.0.</span>
<span class="sd">    orders : int</span>
<span class="sd">        Number of orders of magnitude for up and down tolerance sweep (default is 5).</span>
<span class="sd">    setup : bool</span>
<span class="sd">        If True, run setup before calling compute_totals.</span>
<span class="sd">    run_model : bool</span>
<span class="sd">        If True, run run_model before calling compute_totals.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        A boolean composite of &#39;num_full_jacs&#39; total jacobians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># clear out any old simul coloring info</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_res_jacs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">setup</span><span class="p">:</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">prob</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">run_model</span><span class="p">:</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">reset_iter_counts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">_compute_total_coloring_context</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fullJ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_full_jacs</span><span class="p">):</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_compute_totals</span><span class="p">(</span><span class="n">return_format</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fullJ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fullJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fullJ</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="n">fullJ</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fullJ</span><span class="p">))</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">_tol_sweep</span><span class="p">(</span><span class="n">fullJ</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_full_jacs</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;sparsity_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;total&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full total jacobian was computed </span><span class="si">%d</span><span class="s2"> times, taking </span><span class="si">%f</span><span class="s2"> seconds.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_full_jacs</span><span class="p">,</span>
                                                                             <span class="n">elapsed</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total jacobian shape:&quot;</span><span class="p">,</span> <span class="n">fullJ</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">boolJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fullJ</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">boolJ</span><span class="p">[</span><span class="n">fullJ</span> <span class="o">&gt;</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;good_tol&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">boolJ</span><span class="p">,</span> <span class="n">info</span>


<span class="k">def</span> <span class="nf">_jac2subjac_sparsity</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">wrts</span><span class="p">,</span> <span class="n">of_sizes</span><span class="p">,</span> <span class="n">wrt_sizes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a boolean jacobian and variable names and sizes, compute subjac sparsity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J : ndarray</span>
<span class="sd">        Boolean jacobian.</span>
<span class="sd">    ofs : list of str</span>
<span class="sd">        List of variables corresponding to rows.</span>
<span class="sd">    wrts : list of str</span>
<span class="sd">        List of variables corresponding to columns.</span>
<span class="sd">    of_sizes : ndarray of int</span>
<span class="sd">        Sizes of ofs variables.</span>
<span class="sd">    wrt_sizes : ndarray of int</span>
<span class="sd">        Sizes of wrts variables.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OrderedDict</span>
<span class="sd">        Nested OrderedDict of form sparsity[of][wrt] = (rows, cols, shape)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sparsity</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">row_start</span> <span class="o">=</span> <span class="n">row_end</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">of</span><span class="p">,</span> <span class="n">of_size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ofs</span><span class="p">,</span> <span class="n">of_sizes</span><span class="p">):</span>
        <span class="n">sparsity</span><span class="p">[</span><span class="n">of</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">row_end</span> <span class="o">+=</span> <span class="n">of_size</span>
        <span class="n">col_start</span> <span class="o">=</span> <span class="n">col_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">wrt</span><span class="p">,</span> <span class="n">wrt_size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wrts</span><span class="p">,</span> <span class="n">wrt_sizes</span><span class="p">):</span>
            <span class="n">col_end</span> <span class="o">+=</span> <span class="n">wrt_size</span>

            <span class="c1"># save sparsity structure as  (rows, cols, shape)</span>
            <span class="n">irows</span><span class="p">,</span> <span class="n">icols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">row_start</span><span class="p">:</span><span class="n">row_end</span><span class="p">,</span> <span class="n">col_start</span><span class="p">:</span><span class="n">col_end</span><span class="p">])</span>
            <span class="n">sparsity</span><span class="p">[</span><span class="n">of</span><span class="p">][</span><span class="n">wrt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">irows</span><span class="p">,</span> <span class="n">icols</span><span class="p">,</span> <span class="p">(</span><span class="n">of_size</span><span class="p">,</span> <span class="n">wrt_size</span><span class="p">))</span>

            <span class="n">col_start</span> <span class="o">=</span> <span class="n">col_end</span>

        <span class="n">row_start</span> <span class="o">=</span> <span class="n">row_end</span>

    <span class="k">return</span> <span class="n">sparsity</span>


<span class="k">def</span> <span class="nf">_write_sparsity</span><span class="p">(</span><span class="n">sparsity</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write the sparsity structure to the given stream.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sparsity : dict</span>
<span class="sd">        Nested dict of subjac sparsity for each total derivative.</span>
<span class="sd">    stream : file-like</span>
<span class="sd">        Output stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">last_res_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)):</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="n">sparsity</span><span class="p">[</span><span class="n">out</span><span class="p">]</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;: {</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">out</span><span class="p">)</span>
        <span class="n">last_dv_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)):</span>
            <span class="n">subjac</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="n">inp</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">subjac</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &quot;</span><span class="si">%s</span><span class="s1">&quot;: [</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">inp</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rows</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cols</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &quot;</span><span class="si">%s</span><span class="s1">&quot;: [</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">last_dv_idx</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">last_res_idx</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_desvar_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
    <span class="n">desvars</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_designvars</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">desvars</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_response_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_responses</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">responses</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>


<div class="viewcode-block" id="get_tot_jac_sparsity"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.get_tot_jac_sparsity">[docs]</a><span class="k">def</span> <span class="nf">get_tot_jac_sparsity</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span>
                         <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">],</span>
                         <span class="n">tol</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">],</span>
                         <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute derivative sparsity for the given problem.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem : Problem</span>
<span class="sd">        The Problem being analyzed.</span>
<span class="sd">    mode : str</span>
<span class="sd">        Derivative direction.</span>
<span class="sd">    num_full_jacs : int</span>
<span class="sd">        Number of times to repeat total jacobian computation.</span>
<span class="sd">    tol : float</span>
<span class="sd">        Tolerance used to determine if an array entry is nonzero.</span>
<span class="sd">    setup : bool</span>
<span class="sd">        If True, run setup before calling compute_totals.</span>
<span class="sd">    run_model : bool</span>
<span class="sd">        If True, run run_model before calling compute_totals.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A nested dict specifying subjac sparsity for each total deriv, e.g., sparsity[resp][dv].</span>
<span class="sd">    ndarray</span>
<span class="sd">        Boolean sparsity matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">driver</span>

    <span class="n">J</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_bool_total_jac</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">num_full_jacs</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="n">setup</span><span class="p">,</span>
                               <span class="n">run_model</span><span class="o">=</span><span class="n">run_model</span><span class="p">)</span>

    <span class="n">ofs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_get_ordered_nl_responses</span><span class="p">()</span>
    <span class="n">wrts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">_designvars</span><span class="p">)</span>
    <span class="n">of_sizes</span> <span class="o">=</span> <span class="n">_get_response_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ofs</span><span class="p">)</span>
    <span class="n">wrt_sizes</span> <span class="o">=</span> <span class="n">_get_desvar_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">wrts</span><span class="p">)</span>

    <span class="n">sparsity</span> <span class="o">=</span> <span class="n">_jac2subjac_sparsity</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">wrts</span><span class="p">,</span> <span class="n">of_sizes</span><span class="p">,</span> <span class="n">wrt_sizes</span><span class="p">)</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">_total_jac</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">sparsity</span><span class="p">,</span> <span class="n">J</span></div>


<span class="k">def</span> <span class="nf">_split_groups</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
    <span class="n">uncolored</span> <span class="o">=</span> <span class="p">[</span><span class="n">grp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">grp</span> <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># the first lists entry corresponds to all uncolored columns (columns that are not</span>
    <span class="c1"># disjoint wrt any other columns).  The other entries are groups of columns that do not</span>
    <span class="c1"># share any nonzero row entries in common.</span>
    <span class="n">clists</span> <span class="o">=</span> <span class="p">[</span><span class="n">uncolored</span><span class="p">]</span>
    <span class="n">clists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clists</span>


<span class="k">def</span> <span class="nf">_compute_coloring</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a good coloring in a specified dominant direction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    J : ndarray</span>
<span class="sd">        The boolean total jacobian.</span>
<span class="sd">    mode : str</span>
<span class="sd">        The direction for solving for total derivatives.  Must be &#39;fwd&#39;, &#39;rev&#39; or &#39;auto&#39;.</span>
<span class="sd">        If &#39;auto&#39;, use bidirectional coloring.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Coloring</span>
<span class="sd">        See Coloring class docstring.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>  <span class="c1"># use bidirectional coloring</span>
        <span class="k">return</span> <span class="n">MNCO_bidir</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>

    <span class="n">rev</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;rev&#39;</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">coloring</span> <span class="o">=</span> <span class="n">Coloring</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span>
    <span class="n">col_groups</span> <span class="o">=</span> <span class="n">_split_groups</span><span class="p">(</span><span class="n">_get_full_disjoint_cols</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>

    <span class="n">full_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">col2rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">full_slice</span><span class="p">]</span> <span class="o">*</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># will contain list of nonzero rows for each column</span>
    <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">col_groups</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
            <span class="n">col2rows</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">J</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
        <span class="n">coloring</span><span class="o">.</span><span class="n">_fwd</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_groups</span><span class="p">,</span> <span class="n">col2rows</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">coloring</span><span class="o">.</span><span class="n">_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_groups</span><span class="p">,</span> <span class="n">col2rows</span><span class="p">)</span>

    <span class="n">coloring</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;coloring_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="k">return</span> <span class="n">coloring</span>


<div class="viewcode-block" id="compute_total_coloring"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.compute_total_coloring">[docs]</a><span class="k">def</span> <span class="nf">compute_total_coloring</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">],</span>
                           <span class="n">tol</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">],</span>
                           <span class="n">orders</span><span class="o">=</span><span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">],</span>
                           <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bool_jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute simultaneous derivative colorings for the total jacobian of the given problem.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem : Problem or None</span>
<span class="sd">        The Problem being analyzed.</span>
<span class="sd">    mode : str or None</span>
<span class="sd">        The direction for computing derivatives.  If None, use problem._mode.</span>
<span class="sd">    num_full_jacs : int</span>
<span class="sd">        Number of times to repeat total jacobian computation.</span>
<span class="sd">    tol : float</span>
<span class="sd">        Tolerance used to determine if an array entry is nonzero.</span>
<span class="sd">    orders : int</span>
<span class="sd">        Number of orders above and below the tolerance to check during the tolerance sweep.</span>
<span class="sd">    setup : bool</span>
<span class="sd">        If True, run setup before calling compute_totals.</span>
<span class="sd">    run_model : bool</span>
<span class="sd">        If True, run run_model before calling compute_totals.</span>
<span class="sd">    bool_jac : ndarray</span>
<span class="sd">        If problem is not supplied, a previously computed boolean jacobian can be used.</span>
<span class="sd">    fname : filename or None</span>
<span class="sd">        File where output coloring info will be written. If None, no info will be written.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Coloring</span>
<span class="sd">        See docstring for Coloring class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sparsity</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">problem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">driver</span>
        <span class="n">ofs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_get_ordered_nl_responses</span><span class="p">()</span>
        <span class="n">wrts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">_designvars</span><span class="p">)</span>
        <span class="n">of_sizes</span> <span class="o">=</span> <span class="n">_get_response_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ofs</span><span class="p">)</span>
        <span class="n">wrt_sizes</span> <span class="o">=</span> <span class="n">_get_desvar_sizes</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">wrts</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_approx_schemes</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">_orig_mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">problem</span><span class="o">.</span><span class="n">_orig_mode</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">problem</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;given mode (</span><span class="si">%s</span><span class="s2">) does not agree with Problem mode (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">_mode</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_approx_schemes</span><span class="p">:</span>  <span class="c1"># need to use total approx coloring</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ofs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">_responses</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Currently there is no support for approx coloring when &quot;</span>
                                          <span class="s2">&quot;linear constraint derivatives are computed separately &quot;</span>
                                          <span class="s2">&quot;from nonlinear ones.&quot;</span><span class="p">)</span>
            <span class="n">_initialize_model_approx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">wrts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_coloring_info</span><span class="p">[</span><span class="s1">&#39;coloring&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_approx_schemes</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">run_model</span><span class="p">:</span>
                <span class="n">problem</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
            <span class="n">coloring</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_compute_approx_coloring</span><span class="p">(</span><span class="n">wrt_patterns</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                                                      <span class="n">method</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_approx_schemes</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">num_full_jacs</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                                                      <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">J</span><span class="p">,</span> <span class="n">sparsity_info</span> <span class="o">=</span> <span class="n">_get_bool_total_jac</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">num_full_jacs</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                                                   <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="n">setup</span><span class="p">,</span>
                                                   <span class="n">run_model</span><span class="o">=</span><span class="n">run_model</span><span class="p">)</span>
            <span class="n">coloring</span> <span class="o">=</span> <span class="n">_compute_coloring</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">_row_vars</span> <span class="o">=</span> <span class="n">ofs</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">_row_var_sizes</span> <span class="o">=</span> <span class="n">of_sizes</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">_col_vars</span> <span class="o">=</span> <span class="n">wrts</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">_col_var_sizes</span> <span class="o">=</span> <span class="n">wrt_sizes</span>

            <span class="c1"># save metadata we used to create the coloring</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sparsity_info</span><span class="p">)</span>

            <span class="n">driver</span><span class="o">.</span><span class="n">_total_jac</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">system</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">model</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">system</span><span class="o">.</span><span class="n">_full_comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">system</span><span class="o">.</span><span class="n">_full_comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_full_comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">system</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
                    <span class="n">coloring</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">bool_jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">bool_jac</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">coloring</span> <span class="o">=</span> <span class="n">_compute_coloring</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You must supply either problem or bool_jac to &quot;</span>
                           <span class="s2">&quot;compute_total_coloring().&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coloring</span></div>


<div class="viewcode-block" id="dynamic_derivs_sparsity"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.dynamic_derivs_sparsity">[docs]</a><span class="k">def</span> <span class="nf">dynamic_derivs_sparsity</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute deriv sparsity during runtime.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    driver : &lt;Driver&gt;</span>
<span class="sd">        The driver performing the optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_problem</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_use_derivatives</span><span class="p">:</span>
        <span class="n">simple_warning</span><span class="p">(</span><span class="s2">&quot;Derivatives have been turned off. Skipping dynamic sparsity computation.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">_total_jac</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">num_full_jacs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dynamic_derivs_repeats&#39;</span><span class="p">]</span>

    <span class="c1"># save the total_sparsity.json file for later inspection</span>
    <span class="n">sparsity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_tot_jac_sparsity</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">num_full_jacs</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;total_sparsity.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">_write_sparsity</span><span class="p">(</span><span class="n">sparsity</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">set_total_jac_sparsity</span><span class="p">(</span><span class="n">sparsity</span><span class="p">)</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">_setup_tot_jac_sparsity</span><span class="p">()</span></div>


<div class="viewcode-block" id="dynamic_total_coloring"><a class="viewcode-back" href="../../../_srcdocs/packages/utils/coloring.html#openmdao.utils.coloring.dynamic_total_coloring">[docs]</a><span class="k">def</span> <span class="nf">dynamic_total_coloring</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">run_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute simultaneous deriv coloring during runtime.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    driver : &lt;Driver&gt;</span>
<span class="sd">        The driver performing the optimization.</span>
<span class="sd">    run_model : bool</span>
<span class="sd">        If True, call run_model before computing coloring.</span>
<span class="sd">    fname : str or None</span>
<span class="sd">        Name of file where coloring will be saved.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Coloring</span>
<span class="sd">        The computed coloring.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_problem</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_use_derivatives</span><span class="p">:</span>
        <span class="n">simple_warning</span><span class="p">(</span><span class="s2">&quot;Derivatives have been turned off. Skipping dynamic simul coloring.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">_total_jac</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">problem</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="p">[</span><span class="s1">&#39;coloring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_res_jacs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">num_full_jacs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">,</span>
                                              <span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">])</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">])</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;orders&#39;</span><span class="p">,</span> <span class="n">_DEF_COMP_SPARSITY_ARGS</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">])</span>

    <span class="n">coloring</span> <span class="o">=</span> <span class="n">compute_total_coloring</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">num_full_jacs</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span>
                                      <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_model</span><span class="o">=</span><span class="n">run_model</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="p">[</span><span class="s1">&#39;show_sparsity&#39;</span><span class="p">]:</span>
        <span class="n">coloring</span><span class="o">.</span><span class="n">display_txt</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="p">[</span><span class="s1">&#39;show_summary&#39;</span><span class="p">]:</span>
        <span class="n">coloring</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span><span class="p">[</span><span class="s1">&#39;coloring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coloring</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">_setup_simul_coloring</span><span class="p">()</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">_setup_tot_jac_sparsity</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">coloring</span></div>


<span class="k">def</span> <span class="nf">_total_coloring_setup_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the openmdao subparser for the &#39;openmdao total_coloring&#39; command.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : argparse subparser</span>
<span class="sd">        The parser we&#39;re adding options to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Python file containing the model.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;outfile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output file (pickle format)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;num_jacs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of times to repeat derivative computation when &#39;</span>
                        <span class="s1">&#39;computing sparsity&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--orders&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;orders&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of orders (+/-) used in the tolerance sweep.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--tol&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tolerance&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;tolerance used to determine if a jacobian entry is nonzero&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--jac&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_sparsity&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a visualization of the final jacobian used to &quot;</span>
                        <span class="s2">&quot;compute the coloring.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--jtext&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_sparsity_text&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a text-based visualization of the colored jacobian.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-sparsity&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;no_sparsity&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Exclude the sparsity structure from the coloring data structure.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--profile&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do profiling on the coloring process.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_total_coloring_cmd</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the post_setup hook function for &#39;openmdao total_coloring&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    options : argparse Namespace</span>
<span class="sd">        Command line options.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    function</span>
<span class="sd">        The post-setup hook function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">openmdao.core.problem</span> <span class="k">import</span> <span class="n">Problem</span>
    <span class="kn">from</span> <span class="nn">openmdao.devtools.debug</span> <span class="k">import</span> <span class="n">profiling</span>
    <span class="kn">from</span> <span class="nn">openmdao.utils.general_utils</span> <span class="k">import</span> <span class="n">do_nothing_context</span>

    <span class="k">global</span> <span class="n">_use_total_sparsity</span>

    <span class="n">_use_total_sparsity</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_total_coloring</span><span class="p">(</span><span class="n">prob</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_use_derivatives</span><span class="p">:</span>
            <span class="n">Problem</span><span class="o">.</span><span class="n">_post_setup_func</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># avoid recursive loop</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">:</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;coloring_dir&#39;</span><span class="p">],</span> <span class="s1">&#39;total_coloring.pkl&#39;</span><span class="p">)</span>

            <span class="n">color_info</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_coloring_info</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">tolerance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">color_info</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">orders</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">color_info</span><span class="p">[</span><span class="s1">&#39;orders&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">num_jacs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">num_jacs</span> <span class="o">=</span> <span class="n">color_info</span><span class="p">[</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">]</span>

            <span class="k">with</span> <span class="n">profiling</span><span class="p">(</span><span class="s1">&#39;coloring_profile.out&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">profile</span> <span class="k">else</span> <span class="n">do_nothing_context</span><span class="p">():</span>
                <span class="n">coloring</span> <span class="o">=</span> <span class="n">compute_total_coloring</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span>
                                                  <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">num_jacs</span><span class="p">,</span>
                                                  <span class="n">tol</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span>
                                                  <span class="n">orders</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">orders</span><span class="p">,</span>
                                                  <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_sparsity_text</span><span class="p">:</span>
                <span class="n">coloring</span><span class="o">.</span><span class="n">display_txt</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_sparsity</span><span class="p">:</span>
                <span class="n">coloring</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Derivatives are turned off.  Cannot compute simul coloring.&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_total_coloring</span>


<span class="k">def</span> <span class="nf">_partial_coloring_setup_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the openmdao subparser for the &#39;openmdao partial_color&#39; command.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : argparse subparser</span>
<span class="sd">        The parser we&#39;re adding options to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Python file containing the model.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no_recurse&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;norecurse&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not recurse from the provided system down.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--system&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;pathname of system to color or to start recursing from.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--class&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;compute a coloring for instances of the given class. &#39;</span>
                        <span class="s1">&#39;This option may be be used multiple times to specify multiple classes. &#39;</span>
                        <span class="s1">&#39;Class name can optionally contain the full module path.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--compute_decl_partials&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;compute_decls&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display declare_partials() calls required to specify computed &quot;</span>
                        <span class="s2">&quot;sparsity.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--method&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;method&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;approximation method (&quot;fd&quot; or &quot;cs&quot;).&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--step&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;approximation step size.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--form&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;approximation form (&quot;forward&quot;, &quot;backward&quot;, &quot;central&quot;). Only applies &#39;</span>
                        <span class="s1">&#39;to &quot;fd&quot; method.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--perturbation&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;perturb_size&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;random perturbation size used when computing sparsity.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;num_full_jacs&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of times to repeat derivative computation when &#39;</span>
                        <span class="s1">&#39;computing sparsity&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tol&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;tolerance used to determine if a jacobian entry is nonzero&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--jac&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_sparsity&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a visualization of the colored jacobian.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--jtext&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_sparsity_text&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a text-based visualization of the colored jacobian.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--profile&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do profiling on the coloring process.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_partial_coloring_kwargs</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">system</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t specify --system and --class together.&quot;</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;num_full_jacs&#39;</span><span class="p">,</span> <span class="s1">&#39;perturb_size&#39;</span><span class="p">,</span> <span class="s1">&#39;tol&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;recurse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">norecurse</span>

    <span class="k">return</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">_partial_coloring_cmd</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the post_setup hook function for &#39;openmdao partial_color&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    options : argparse Namespace</span>
<span class="sd">        Command line options.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    function</span>
<span class="sd">        The post-setup hook function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">openmdao.core.problem</span> <span class="k">import</span> <span class="n">Problem</span>
    <span class="kn">from</span> <span class="nn">openmdao.core.component</span> <span class="k">import</span> <span class="n">Component</span>
    <span class="kn">from</span> <span class="nn">openmdao.devtools.debug</span> <span class="k">import</span> <span class="n">profiling</span>
    <span class="kn">from</span> <span class="nn">openmdao.utils.general_utils</span> <span class="k">import</span> <span class="n">do_nothing_context</span>

    <span class="k">global</span> <span class="n">_use_partial_sparsity</span><span class="p">,</span> <span class="n">_force_dyn_coloring</span>

    <span class="n">_use_partial_sparsity</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_force_dyn_coloring</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_show</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">coloring</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_sparsity_text</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_sparsity&#39;</span><span class="p">):</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">display_txt</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_sparsity</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_sparsity&#39;</span><span class="p">):</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_summary&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Approx coloring for &#39;</span><span class="si">%s</span><span class="s2">&#39; (class </span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">pathname</span><span class="p">,</span>
                                                               <span class="nb">type</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">coloring</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">compute_decls</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    # add the following lines to class </span><span class="si">%s</span><span class="s1"> to declare sparsity&#39;</span> <span class="o">%</span>
                  <span class="nb">type</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">coloring</span><span class="o">.</span><span class="n">get_declare_partials_calls</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_partial_coloring</span><span class="p">(</span><span class="n">prob</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_use_derivatives</span><span class="p">:</span>
            <span class="n">Problem</span><span class="o">.</span><span class="n">_post_setup_func</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># avoid recursive loop</span>

            <span class="n">prob</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>  <span class="c1"># get a consistent starting values for inputs and outputs</span>

            <span class="k">with</span> <span class="n">profiling</span><span class="p">(</span><span class="s1">&#39;coloring_profile.out&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">profile</span> <span class="k">else</span> <span class="n">do_nothing_context</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">system</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span>
                    <span class="n">_initialize_model_approx</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">system</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_subsystem</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">system</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find system with pathname &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>

                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">_get_partial_coloring_kwargs</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
                <span class="n">recurse</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">norecurse</span>

                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                    <span class="n">to_find</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;recurse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                            <span class="n">klass</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">klass</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">mod</span><span class="p">,</span> <span class="n">klass</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">to_find</span><span class="p">:</span>
                                    <span class="n">found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">coloring</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_compute_approx_coloring</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following error occurred while attempting to &quot;</span>
                                          <span class="s2">&quot;compute coloring for </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pathname</span><span class="p">,</span> <span class="n">tb</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">coloring</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">norecurse</span><span class="p">:</span>
                                    <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">to_find</span> <span class="o">-</span> <span class="n">found</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to find any instance of classes </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                               <span class="nb">sorted</span><span class="p">(</span><span class="n">to_find</span> <span class="o">-</span> <span class="n">found</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colorings</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_compute_approx_coloring</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">colorings</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No coloring found.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colorings</span><span class="p">:</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;pathname&#39;</span><span class="p">]</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_subsystem</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">prob</span><span class="o">.</span><span class="n">model</span>
                            <span class="n">_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Derivatives are turned off.  Cannot compute simul coloring.&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">_partial_coloring</span>


<span class="k">def</span> <span class="nf">_sparsity_setup_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the openmdao subparser for the &#39;openmdao sparsity&#39; command.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : argparse subparser</span>
<span class="sd">        The parser we&#39;re adding options to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Python file containing the model.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;outfile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output file (json format).&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;num_jacs&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of times to repeat total derivative computation.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tolerance&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;tolerance used to determine if a total jacobian entry is nonzero.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--jac&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_sparsity&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a visualization of the final total jacobian used to &quot;</span>
                        <span class="s2">&quot;compute the sparsity.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_sparsity_cmd</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the post_setup hook function for &#39;openmdao total_sparsity&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    options : argparse Namespace</span>
<span class="sd">        Command line options.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    function</span>
<span class="sd">        The post-setup hook function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">openmdao.core.problem</span> <span class="k">import</span> <span class="n">Problem</span>
    <span class="k">global</span> <span class="n">_use_total_sparsity</span>

    <span class="n">_use_total_sparsity</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_sparsity</span><span class="p">(</span><span class="n">prob</span><span class="p">):</span>
        <span class="n">Problem</span><span class="o">.</span><span class="n">_post_setup_func</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># avoid recursive loop</span>
        <span class="n">sparsity</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">get_tot_jac_sparsity</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">num_full_jacs</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">num_jacs</span><span class="p">,</span>
                                           <span class="n">tol</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="n">prob</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_model</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">_write_sparsity</span><span class="p">(</span><span class="n">sparsity</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_sparsity</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ofs</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_get_ordered_nl_responses</span><span class="p">()</span>
            <span class="n">wrts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_designvars</span><span class="p">)</span>
            <span class="n">array_viz</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">wrts</span><span class="p">)</span>

        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_sparsity</span>


<span class="k">def</span> <span class="nf">_view_coloring_setup_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the openmdao subparser for the &#39;openmdao view_coloring&#39; command.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : argparse subparser</span>
<span class="sd">        The parser we&#39;re adding options to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;coloring file.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_sparsity&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a visualization of the colored jacobian.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--jtext&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_sparsity_text&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a text-based visualization of the colored jacobian.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;subjac_sparsity&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display sparsity patterns for subjacs.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_meta&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display coloring metadata.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--var&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;color_var&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;show the coloring (number of fwd and rev solves needed) &#39;</span>
                        <span class="s1">&#39;for a particular variable.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_view_coloring_exec</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the &#39;openmdao view_coloring&#39; command.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    options : argparse Namespace</span>
<span class="sd">        Command line options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coloring</span> <span class="o">=</span> <span class="n">Coloring</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_sparsity_text</span><span class="p">:</span>
        <span class="n">coloring</span><span class="o">.</span><span class="n">display_txt</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_sparsity</span><span class="p">:</span>
        <span class="n">coloring</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">subjac_sparsity</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Subjacobian sparsity:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">coloring</span><span class="o">.</span><span class="n">_subjac_sparsity_iter</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">   rows=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">   cols=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tup</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">color_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fwd</span><span class="p">,</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">coloring</span><span class="o">.</span><span class="n">get_row_var_coloring</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">color_var</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Var: </span><span class="si">%s</span><span class="s2">  (fwd solves: </span><span class="si">%d</span><span class="s2">,  rev solves: </span><span class="si">%d</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">color_var</span><span class="p">,</span> <span class="n">fwd</span><span class="p">,</span> <span class="n">rev</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_meta</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coloring metadata:&quot;</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">coloring</span><span class="o">.</span><span class="n">_meta</span><span class="p">)</span>

    <span class="n">coloring</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_initialize_model_approx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up internal data structures needed for computing approx totals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">of</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">_get_ordered_nl_responses</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">wrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wrt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">_designvars</span><span class="p">)</span>

    <span class="c1"># Initialization based on driver (or user) -requested &quot;of&quot; and &quot;wrt&quot;.</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_jac</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_of</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_of</span> <span class="o">!=</span> <span class="n">of</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_wrt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_wrt</span> <span class="o">!=</span> <span class="n">wrt</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_of</span> <span class="o">=</span> <span class="n">of</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_wrt</span> <span class="o">=</span> <span class="n">wrt</span>

        <span class="c1"># Support for indices defined on driver vars.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_of_idx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">_responses</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_owns_approx_wrt_idx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">_designvars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenMDAO 2.8.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, openmdao.org.
      Last updated on Aug 08, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>